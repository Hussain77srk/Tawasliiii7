<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التواصل مع أولياء أمور الطلاب</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/chart.js"></script>
    <script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        secondary: '#4C51BF',
                        accent: '#EDF2F7',
                    },
                    fontFamily: {
                        cairo: ['Cairo', 'sans-serif'],
                    }
                },
            },
            darkMode: 'class',
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Cairo', sans-serif;
        }
        body {
            transition: background-color 0.3s, color 0.3s;
            scroll-behavior: smooth;
        }
        :root {
            --shadow-color: rgba(0, 0, 0, 0.1);
        }
        .dark {
            --shadow-color: rgba(255, 255, 255, 0.05);
        }
        .card {
            box-shadow: 0 4px 6px var(--shadow-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px var(--shadow-color);
        }
        .dark .stat-value {
            color: #5D5CDE;
        }
        .dark .stat-title {
            color: #e2e8f0;
        }
        input[type="text"], input[type="tel"], input[type="number"], select, textarea {
            min-height: 42px;
            font-size: 16px; /* Prevent zoom on mobile */
        }
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }
        @keyframes fadeIn {
            0% { opacity: 0; }
            100% { opacity: 1; }
        }
        .loading {
            position: relative;
        }
        .loading:after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .dark .loading:after {
            background: rgba(0, 0, 0, 0.7);
        }
        /* Responsive table */
        .responsive-table {
            overflow-x: auto;
        }
        /* Toggle switch for dark mode */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #5D5CDE;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        .success-message {
            color: #10b981;
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }
        /* Logo styling */
        .school-logo {
            max-width: 100px;
            max-height: 100px;
            transition: transform 0.3s;
        }
        .school-logo:hover {
            transform: scale(1.05);
        }
        /* Message status indicator */
        .message-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-left: 5px;
        }
        .status-sent {
            background-color: #10b981;
        }
        .status-pending {
            background-color: #f59e0b;
        }
        .status-failed {
            background-color: #ef4444;
        }
        .status-scheduled {
            background-color: #6366f1;
        }
        /* Tab styling */
        .tab {
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }
        .tab.active {
            border-bottom: 2px solid #5D5CDE;
            color: #5D5CDE;
        }
        .tab:hover:not(.active) {
            border-bottom: 2px solid #e2e8f0;
        }
        .dark .tab:hover:not(.active) {
            border-bottom: 2px solid #4a5568;
        }
        /* Checkbox styling */
        .custom-checkbox {
            border: 2px solid #cbd5e0;
            border-radius: 4px;
            width: 18px;
            height: 18px;
            display: inline-block;
            position: relative;
            cursor: pointer;
            transition: all 0.2s;
        }
        .custom-checkbox:hover {
            border-color: #5D5CDE;
        }
        .custom-checkbox.checked {
            background-color: #5D5CDE;
            border-color: #5D5CDE;
        }
        .custom-checkbox.checked:after {
            content: '';
            position: absolute;
            top: 3px;
            left: 6px;
            width: 5px;
            height: 9px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }
        /* Modal styling for settings */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.show {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            width: 100%;
            max-width: 500px;
            border-radius: 8px;
            overflow: hidden;
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }
        .dark .modal-content {
            background-color: #1f2937;
        }
        .modal.show .modal-content {
            transform: translateY(0);
        }
        /* Pulse animation for sending status */
        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }
        .animate-pulse {
            animation: pulse 2s infinite;
        }
        /* Settings panel and templates */
        .settings-section {
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .dark .settings-section {
            border-bottom-color: #4a5568;
        }
        .settings-heading {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        /* Batch progress */
        .batch-progress-container {
            margin-top: 1rem;
        }
        .batch-progress {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }
        .dark .batch-progress {
            background-color: #4a5568;
        }
        .batch-progress-value {
            height: 100%;
            background-color: #5D5CDE;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        /* File upload styling */
        .file-upload {
            position: relative;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }
        .file-upload input[type=file] {
            position: absolute;
            font-size: 100px;
            left: 0;
            top: 0;
            opacity: 0;
            cursor: pointer;
        }
        .file-preview {
            max-width: 100%;
            margin-top: 10px;
            max-height: 150px;
            border-radius: 4px;
        }
        .file-name {
            margin-top: 5px;
            font-size: 0.875rem;
            color: #4b5563;
            word-break: break-all;
        }
        .dark .file-name {
            color: #9ca3af;
        }
        .upload-progress {
            width: 100%;
            height: 4px;
            background-color: #e2e8f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 5px;
        }
        .dark .upload-progress {
            background-color: #4a5568;
        }
        .upload-progress-value {
            height: 100%;
            background-color: #5D5CDE;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        /* Enhanced styling for WhatsApp message panel */
        .whatsapp-panel {
            border-right: 4px solid #25D366;
            padding-right: 12px;
            position: relative;
        }
        .whatsapp-panel::before {
            content: '';
            position: absolute;
            right: -10px;
            top: 15px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid #25D366;
        }
        /* Confirmation dialog */
        .confirm-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 60;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .confirm-dialog {
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            max-width: 400px;
            width: 90%;
            text-align: center;
        }
        .dark .confirm-dialog {
            background-color: #1f2937;
        }
        .confirm-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        /* Bounce animation for WhatsApp icon */
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-10px);}
            60% {transform: translateY(-5px);}
        }
        .bounce {
            animation: bounce 2s infinite;
        }
        /* Excel import styles */
        .import-step {
            display: none;
        }
        .import-step.active {
            display: block;
        }
        .excel-column {
            background-color: #f3f4f6;
            padding: 0.5rem;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            border: 1px solid #e5e7eb;
            transition: all 0.3s;
        }
        .dark .excel-column {
            background-color: #374151;
            border-color: #4b5563;
        }
        .excel-column:hover {
            border-color: #5D5CDE;
        }
        .excel-preview-table {
            font-size: 0.875rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .mapping-field {
            background-color: #eef2ff;
            border: 1px solid #e0e7ff;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            color: #5D5CDE;
            font-size: 0.75rem;
            display: inline-block;
            margin: 0.25rem;
        }
        .dark .mapping-field {
            background-color: #312e81;
            border-color: #4f46e5;
        }
        .table-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .dark .table-hint {
            color: #9ca3af;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-200 min-h-screen">
    <!-- تفعيل الوضع المظلم تلقائياً -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>
    
    <!-- رأس الصفحة مع الشعار واسم التطبيق -->
    <header class="bg-white dark:bg-gray-800 shadow-md p-4">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4 space-x-reverse">
                <div class="rounded-full overflow-hidden bg-white p-2">
                    <img src="https://www2.0zz0.com/2025/05/16/10/678053678.jpeg" alt="شعار المدرسة" class="school-logo">
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold">نظام التواصل مع أولياء الأمور</h1>
                    <p class="text-sm text-gray-600 dark:text-gray-400">مدرسة الثروات الوطنيه الخاصه</p>
                </div>
            </div>
            
            <div class="flex items-center space-x-4 space-x-reverse">
                <!-- زر الإعدادات -->
                <button id="settings-button" class="text-gray-700 dark:text-gray-300 hover:text-primary dark:hover:text-primary mr-3">
                    <i class="fas fa-cog text-lg"></i>
                </button>
                
                <!-- مفتاح الوضع المظلم -->
                <label class="switch">
                    <input type="checkbox" id="darkModeToggle">
                    <span class="slider"></span>
                </label>
                <span class="hidden md:inline-block">الوضع المظلم</span>
            </div>
        </div>
    </header>

    <!-- قائمة التبويبات الرئيسية -->
    <div class="bg-white dark:bg-gray-800 border-b border-gray-200 dark:border-gray-700">
        <div class="container mx-auto">
            <div class="flex overflow-x-auto whitespace-nowrap">
                <button class="tab active px-4 py-3 font-medium text-gray-800 dark:text-gray-200" data-tab="students">
                    <i class="fas fa-user-graduate ml-2"></i>الطلاب
                </button>
                <button class="tab px-4 py-3 font-medium text-gray-800 dark:text-gray-200" data-tab="messages">
                    <i class="fab fa-whatsapp ml-2"></i>الرسائل
                </button>
                <button class="tab px-4 py-3 font-medium text-gray-800 dark:text-gray-200" data-tab="stats">
                    <i class="fas fa-chart-line ml-2"></i>الإحصائيات
                </button>
                <button class="tab px-4 py-3 font-medium text-gray-800 dark:text-gray-200" data-tab="reports">
                    <i class="fas fa-file-export ml-2"></i>التقارير
                </button>
                <button class="tab px-4 py-3 font-medium text-gray-800 dark:text-gray-200" data-tab="scheduled">
                    <i class="fas fa-calendar-alt ml-2"></i>الرسائل المجدولة
                </button>
            </div>
        </div>
    </div>

    <!-- منطقة المحتوى الرئيسية -->
    <main class="container mx-auto p-4">
        <!-- تبويب الطلاب -->
        <section id="students-tab" class="tab-content fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- بطاقة إضافة طالب -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 col-span-1 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">
                            <i class="fas fa-user-graduate text-primary ml-2"></i>
                            إضافة طالب جديد
                        </h2>
                        <button id="toggle-import" class="text-primary hover:text-secondary flex items-center text-sm">
                            <i class="fas fa-file-excel ml-1"></i> استيراد من Excel
                        </button>
                    </div>

                    <!-- نموذج إضافة طالب -->
                    <div id="manual-entry">
                        <form id="student-form" class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">رقم الاسيس*</label>
                                <input type="number" id="student-id" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">اسم الطالب*</label>
                                <input type="text" id="student-name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">الصف*</label>
                                    <select id="grade" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر الصف</option>
                                        <option value="روضة أولى">روضة أولى (KG1)</option>
                                        <option value="روضة ثانية">روضة ثانية (KG2)</option>
                                        <option value="الأول">الأول</option>
                                        <option value="الثاني">الثاني</option>
                                        <option value="الثالث">الثالث</option>
                                        <option value="الرابع">الرابع</option>
                                        <option value="الخامس">الخامس</option>
                                        <option value="السادس">السادس</option>
                                        <option value="السابع">السابع</option>
                                        <option value="الثامن">الثامن</option>
                                        <option value="التاسع">التاسع</option>
                                        <option value="العاشر">العاشر</option>
                                        <option value="الحادي عشر">الحادي عشر</option>
                                        <option value="الثاني عشر">الثاني عشر</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الفصل*</label>
                                    <select id="class-room" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر الفصل</option>
                                        <option value="أ">أ</option>
                                        <option value="ب">ب</option>
                                        <option value="ج">ج</option>
                                        <option value="د">د</option>
                                    </select>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">الفصل الدراسي*</label>
                                    <select id="semester" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر الفصل الدراسي</option>
                                        <option value="الأول">الأول</option>
                                        <option value="الثاني">الثاني</option>
                                        <option value="الثالث">الثالث</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الجنس*</label>
                                    <select id="gender" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر الجنس</option>
                                        <option value="ذكر">ذكر</option>
                                        <option value="أنثى">أنثى</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">المنطقة</label>
                                <input type="text" id="region" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">رقم هاتف ولي الأمر*</label>
                                <input type="tel" id="parent-phone" required placeholder="مثال: 971512345678" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">أدخل رقم الهاتف مع كود الدولة (مثال: 971512345678)</p>
                            </div>
                            <div class="pt-2">
                                <button type="submit" class="w-full bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                                    <i class="fas fa-save ml-2"></i>حفظ البيانات
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- قسم استيراد ملف Excel -->
                    <div id="excel-import" class="hidden">
                        <div class="import-step active" id="step-1">
                            <div class="mb-4">
                                <h3 class="text-md font-semibold mb-2">استيراد بيانات الطلاب من ملف Excel</h3>
                                <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">يمكنك استيراد بيانات الطلاب عبر رفع ملف Excel. تأكد من أن الملف يحتوي على الأعمدة الضرورية.</p>
                                
                                <div class="file-upload w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 px-4 rounded-md text-center">
                                    <i class="fas fa-file-excel ml-2"></i>
                                    <span>اختر ملف Excel للاستيراد</span>
                                    <input type="file" id="excel-file" accept=".xlsx, .xls" class="cursor-pointer">
                                </div>
                                
                                <div id="excel-file-info" class="hidden mt-2">
                                    <div class="file-name"></div>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-4">
                                <button id="cancel-import" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md transition duration-200">
                                    إلغاء
                                </button>
                                <button id="next-step-1" disabled class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium opacity-50 cursor-not-allowed">
                                    التالي <i class="fas fa-arrow-left mr-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="import-step" id="step-2">
                            <h3 class="text-md font-semibold mb-2">مراجعة البيانات</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">تمت قراءة <span id="rows-count" class="font-semibold">0</span> صف من الملف.</p>
                            
                            <div class="excel-preview-table responsive-table mb-4">
                                <table id="excel-preview" class="min-w-full border-collapse">
                                    <thead>
                                        <tr class="bg-gray-100 dark:bg-gray-700">
                                            <!-- سيتم إضافة رؤوس الأعمدة هنا -->
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- سيتم إضافة صفوف البيانات هنا -->
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="flex justify-between mt-4">
                                <button id="back-step-2" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md transition duration-200">
                                    <i class="fas fa-arrow-right ml-2"></i> السابق
                                </button>
                                <button id="next-step-2" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                                    التالي <i class="fas fa-arrow-left mr-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="import-step" id="step-3">
                            <h3 class="text-md font-semibold mb-2">ربط الأعمدة</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-2">يرجى ربط أعمدة ملف Excel مع حقول بيانات الطلاب</p>
                            
                            <div class="space-y-3 mb-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">رقم الاسيس*</label>
                                    <select id="map-student-id" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">اسم الطالب*</label>
                                    <select id="map-student-name" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الصف*</label>
                                    <select id="map-grade" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الفصل*</label>
                                    <select id="map-class-room" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الفصل الدراسي*</label>
                                    <select id="map-semester" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الجنس*</label>
                                    <select id="map-gender" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">المنطقة</label>
                                    <select id="map-region" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">رقم هاتف ولي الأمر*</label>
                                    <select id="map-parent-phone" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="">اختر العمود المقابل</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex justify-between mt-4">
                                <button id="back-step-3" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md transition duration-200">
                                    <i class="fas fa-arrow-right ml-2"></i> السابق
                                </button>
                                <button id="next-step-3" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                                    التالي <i class="fas fa-arrow-left mr-2"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="import-step" id="step-4">
                            <h3 class="text-md font-semibold mb-2">تأكيد الاستيراد</h3>
                            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                مراجعة نهائية قبل استيراد البيانات. سيتم استيراد <span id="valid-rows-count" class="font-semibold">0</span> طالب.
                            </p>
                            
                            <div class="p-3 bg-blue-50 dark:bg-blue-900 rounded-md mb-4">
                                <p class="text-sm text-blue-800 dark:text-blue-200">
                                    <i class="fas fa-info-circle ml-1"></i>
                                    يرجى التأكد من أن جميع البيانات صحيحة قبل الاستمرار. سيتم إنشاء سجلات جديدة للطلاب، ويمكن أن يؤدي ذلك إلى تكرار السجلات إذا كانت البيانات موجودة بالفعل.
                                </p>
                            </div>
                            
                            <div class="rounded-md border border-gray-300 dark:border-gray-700 p-3 mb-4">
                                <h4 class="font-medium mb-2">ملخص الاستيراد</h4>
                                <ul id="import-summary" class="text-sm space-y-1 list-inside list-disc">
                                    <!-- سيتم إضافة ملخص الاستيراد هنا -->
                                </ul>
                            </div>
                            
                            <div class="flex justify-between mt-4">
                                <button id="back-step-4" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md transition duration-200">
                                    <i class="fas fa-arrow-right ml-2"></i> السابق
                                </button>
                                <button id="import-data" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                                    <i class="fas fa-file-import ml-2"></i> استيراد البيانات
                                </button>
                            </div>
                        </div>
                        
                        <div class="import-step" id="step-5">
                            <div class="text-center py-8">
                                <div id="import-progress-container">
                                    <h3 class="text-md font-semibold mb-2">جاري استيراد البيانات...</h3>
                                    <div class="w-20 h-20 mx-auto mb-4">
                                        <div class="animate-spin rounded-full h-20 w-20 border-b-2 border-primary"></div>
                                    </div>
                                    <p id="import-progress-text" class="text-sm text-gray-600 dark:text-gray-400">
                                        جاري استيراد <span id="current-imported">0</span> من <span id="total-to-import">0</span>
                                    </p>
                                    <div class="w-full bg-gray-200 dark:bg-gray-700 h-2 rounded-full mt-4 mb-4">
                                        <div id="import-progress-bar" class="bg-primary h-2 rounded-full" style="width: 0%"></div>
                                    </div>
                                </div>
                                
                                <div id="import-success" class="hidden">
                                    <div class="text-green-500 flex justify-center mb-4">
                                        <i class="fas fa-check-circle text-5xl"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold mb-2">تم الاستيراد بنجاح!</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                        تم استيراد <span id="success-count" class="font-semibold">0</span> طالب بنجاح.
                                    </p>
                                </div>
                                
                                <div id="import-error" class="hidden">
                                    <div class="text-red-500 flex justify-center mb-4">
                                        <i class="fas fa-times-circle text-5xl"></i>
                                    </div>
                                    <h3 class="text-lg font-semibold mb-2">حدث خطأ أثناء الاستيراد</h3>
                                    <p id="error-message" class="text-sm text-red-600 dark:text-red-400 mb-4">
                                        حدث خطأ أثناء استيراد البيانات.
                                    </p>
                                </div>
                                
                                <div class="mt-6">
                                    <button id="finish-import" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium hidden">
                                        <i class="fas fa-check ml-2"></i> إنهاء
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="form-message" class="mt-3 text-center hidden"></div>
                </div>
                
                <!-- إحصائيات الطلاب -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 md:col-span-2 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">
                            <i class="fas fa-list text-primary ml-2"></i>
                            قائمة الطلاب
                        </h2>
                        <div class="flex space-x-2 space-x-reverse">
                            <div class="relative">
                                <input type="text" id="search-student" placeholder="بحث..." class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400"></i>
                            </div>
                            <button id="export-students" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 flex items-center">
                                <i class="fas fa-file-export ml-2"></i>
                                <span class="hidden sm:inline">تصدير</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="responsive-table">
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">#</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">الاسم</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">الصف</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">رقم ولي الأمر</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="students-table">
                                <!-- سيتم إضافة صفوف الطلاب هنا ديناميكيًا -->
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                        <div class="flex justify-center">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                        </div>
                                        <p class="mt-2">جاري تحميل البيانات...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- تبويب الرسائل -->
        <section id="messages-tab" class="tab-content hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- بطاقة إنشاء رسالة -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="mb-4 flex justify-between items-center">
                        <h2 class="text-lg font-bold">
                            <i class="fab fa-whatsapp text-primary ml-2"></i>
                            إرسال رسالة واتساب
                        </h2>
                        <button id="toggle-message-templates" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-1 px-3 rounded-md text-sm transition duration-200">
                            <i class="fas fa-list-alt ml-1"></i>
                            <span>قوالب الرسائل</span>
                        </button>
                    </div>
                    
                    <!-- لوحة قوالب الرسائل (مخفية افتراضيًا) -->
                    <div id="message-templates-panel" class="mb-4 hidden">
                        <div class="mb-3 rounded-lg border border-gray-300 dark:border-gray-600 p-3">
                            <h3 class="text-md font-semibold mb-2">قوالب الرسائل الجاهزة</h3>
                            <div class="grid grid-cols-1 gap-2 max-h-40 overflow-y-auto">
                                <button class="template-button text-right bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded text-sm" data-template="نرجو العلم بأنه سيتم عقد اجتماع أولياء الأمور يوم [اليوم] القادم الساعة [الوقت] في [المكان].">
                                    اجتماع أولياء الأمور
                                </button>
                                <button class="template-button text-right bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded text-sm" data-template="نذكركم بأن آخر موعد لتسليم [المهمة] هو يوم [اليوم] الموافق [التاريخ].">
                                    تذكير بالمواعيد النهائية
                                </button>
                                <button class="template-button text-right bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded text-sm" data-template="نود إعلامكم بأن الطالب [اسم الطالب] كان متغيباً عن المدرسة اليوم. يرجى التواصل مع إدارة المدرسة.">
                                    إشعار غياب
                                </button>
                                <button class="template-button text-right bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded text-sm" data-template="نهنئكم بمناسبة [المناسبة] ونتمنى لكم قضاء وقت سعيد مع العائلة.">
                                    تهنئة بمناسبة
                                </button>
                                <button class="template-button text-right bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded text-sm" data-template="تم تغيير موعد الاختبار من [الموعد القديم] إلى [الموعد الجديد]. نرجو الاستعداد والحضور.">
                                    تغيير موعد اختبار
                                </button>
                                <button class="template-button text-right bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 p-2 rounded text-sm" data-template="نعلمكم بإقامة رحلة مدرسية يوم [اليوم] إلى [المكان]. برجاء تعبئة نموذج الموافقة.">
                                    إعلان رحلة مدرسية
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <form id="message-form" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">نوع الرسالة</label>
                            <select id="message-type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="text">رسالة نصية</option>
                                <option value="file">مرفق</option>
                            </select>
                        </div>
                        
                        <div id="text-message-container">
                            <label class="block text-sm font-medium mb-1">نص الرسالة*</label>
                            <textarea id="message-text" rows="4" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base"></textarea>
                        </div>
                        
                        <div id="file-message-container" class="hidden">
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">نوع المرفق</label>
                                <select id="file-type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="pdf">ملف PDF</option>
                                    <option value="image">صورة</option>
                                    <option value="excel">ملف Excel</option>
                                    <option value="word">ملف Word</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1">اختر الملف*</label>
                                <div class="file-upload w-full bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 px-4 rounded-md text-center">
                                    <i class="fas fa-upload ml-2"></i>
                                    <span>اختر ملف للرفع</span>
                                    <input type="file" id="file-attachment" class="cursor-pointer">
                                </div>
                                <div id="file-upload-info" class="hidden mt-2">
                                    <div class="file-name"></div>
                                    <div class="upload-progress">
                                        <div class="upload-progress-value" style="width: 0%"></div>
                                    </div>
                                </div>
                                <div id="file-preview-container" class="hidden mt-2 text-center">
                                    <img id="file-preview" class="file-preview mx-auto">
                                </div>
                            </div>
                            
                            <div class="mt-3">
                                <label class="block text-sm font-medium mb-1">نص الرسالة (اختياري)</label>
                                <textarea id="file-message-text" rows="2" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base" placeholder="نص الرسالة المرافق للملف..."></textarea>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">المستلمون*</label>
                            <select id="recipients-type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="all">جميع أولياء الأمور</option>
                                <option value="grade">حسب الصف</option>
                                <option value="class">حسب الفصل</option>
                                <option value="individual">طلاب محددين</option>
                            </select>
                        </div>
                        
                        <div id="grade-filter" class="hidden">
                            <label class="block text-sm font-medium mb-1">اختر الصف</label>
                            <select id="message-grade" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="روضة أولى">روضة أولى (KG1)</option>
                                <option value="روضة ثانية">روضة ثانية (KG2)</option>
                                <option value="الأول">الأول</option>
                                <option value="الثاني">الثاني</option>
                                <option value="الثالث">الثالث</option>
                                <option value="الرابع">الرابع</option>
                                <option value="الخامس">الخامس</option>
                                <option value="السادس">السادس</option>
                                <option value="السابع">السابع</option>
                                <option value="الثامن">الثامن</option>
                                <option value="التاسع">التاسع</option>
                                <option value="العاشر">العاشر</option>
                                <option value="الحادي عشر">الحادي عشر</option>
                                <option value="الثاني عشر">الثاني عشر</option>
                            </select>
                        </div>
                        
                        <div id="class-filter" class="hidden">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">الصف</label>
                                    <select id="class-grade" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="روضة أولى">روضة أولى (KG1)</option>
                                        <option value="روضة ثانية">روضة ثانية (KG2)</option>
                                        <option value="الأول">الأول</option>
                                        <option value="الثاني">الثاني</option>
                                        <option value="الثالث">الثالث</option>
                                        <option value="الرابع">الرابع</option>
                                        <option value="الخامس">الخامس</option>
                                        <option value="السادس">السادس</option>
                                        <option value="السابع">السابع</option>
                                        <option value="الثامن">الثامن</option>
                                        <option value="التاسع">التاسع</option>
                                        <option value="العاشر">العاشر</option>
                                        <option value="الحادي عشر">الحادي عشر</option>
                                        <option value="الثاني عشر">الثاني عشر</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الفصل</label>
                                    <select id="class-section" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                        <option value="أ">أ</option>
                                        <option value="ب">ب</option>
                                        <option value="ج">ج</option>
                                        <option value="د">د</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div id="individual-filter" class="hidden">
                            <label class="block text-sm font-medium mb-1">اختر الطلاب</label>
                            <div id="students-selection" class="max-h-40 overflow-y-auto border border-gray-300 dark:border-gray-700 rounded-md p-2 dark:bg-gray-700">
                                <!-- سيتم إضافة خانات اختيار الطلاب هنا ديناميكيًا -->
                                <div class="text-center text-gray-500 dark:text-gray-400 py-2">
                                    <div class="flex justify-center">
                                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                                    </div>
                                    <p class="mt-2">جاري تحميل قائمة الطلاب...</p>
                                </div>
                            </div>
                            <div class="mt-2 text-left">
                                <button type="button" id="select-all-students" class="text-sm text-primary hover:text-secondary">تحديد الكل</button>
                                <span class="mx-2">|</span>
                                <button type="button" id="deselect-all-students" class="text-sm text-primary hover:text-secondary">إلغاء تحديد الكل</button>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex items-center">
                                <input type="checkbox" id="schedule-message" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                <label for="schedule-message" class="mr-2 block text-sm">
                                    جدولة الرسالة لوقت لاحق
                                </label>
                            </div>
                            
                            <div id="schedule-container" class="hidden grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">التاريخ</label>
                                    <input type="date" id="schedule-date" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">الوقت</label>
                                    <input type="time" id="schedule-time" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                </div>
                            </div>
                        </div>
                        
                        <!-- خيار الإرسال -->
                        <div class="rounded-lg bg-gray-100 dark:bg-gray-700 p-3 whatsapp-panel">
                            <h3 class="font-medium mb-2 text-green-600 dark:text-green-400">
                                <i class="fab fa-whatsapp ml-1"></i>طريقة الإرسال
                            </h3>
                            
                            <div class="flex items-center mb-2">
                                <input type="radio" id="send-method-direct" name="send-method" value="direct" checked class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <label for="send-method-direct" class="mr-2 block text-sm">
                                    فتح واتساب مباشرة للإرسال (رابط wa.me)
                                </label>
                            </div>
                            
                            <div class="flex items-center">
                                <input type="radio" id="send-method-web" name="send-method" value="web" class="h-4 w-4 text-primary focus:ring-primary border-gray-300">
                                <label for="send-method-web" class="mr-2 block text-sm">
                                    استخدام واتساب ويب (للرسائل الجماعية)
                                </label>
                            </div>
                            
                            <div id="advanced-options" class="mt-2 pt-2 border-t border-gray-200 dark:border-gray-600">
                                <div class="flex items-center">
                                    <input type="checkbox" id="use-delay" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                                    <label for="use-delay" class="mr-2 block text-sm">
                                        استخدام تأخير بين الرسائل (لتجنب الحظر)
                                    </label>
                                </div>
                                
                                <div id="delay-options" class="mt-2 pr-6 hidden">
                                    <label class="block text-sm font-medium mb-1">مدة التأخير (ثانية)</label>
                                    <input type="number" id="delay-seconds" min="1" max="10" value="3" class="w-20 px-3 py-1 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div class="pt-2">
                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                                <i class="fab fa-whatsapp ml-2 bounce"></i>إرسال الرسالة
                            </button>
                        </div>
                    </form>
                    
                    <div id="message-status" class="mt-3 text-center hidden"></div>
                    
                    <div id="send-progress" class="mt-3 hidden">
                        <div class="text-sm text-gray-600 dark:text-gray-400 mb-1 flex justify-between">
                            <span id="send-progress-text">جاري الإرسال (<span id="send-progress-current">0</span>/<span id="send-progress-total">0</span>)</span>
                            <span id="send-progress-percent">0%</span>
                        </div>
                        <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2.5">
                            <div id="send-progress-bar" class="bg-green-600 h-2.5 rounded-full" style="width: 0%"></div>
                        </div>
                        <div id="send-progress-info" class="mt-2 text-sm text-center text-gray-600 dark:text-gray-400"></div>
                    </div>
                </div>
                
                <!-- سجل الرسائل -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 md:col-span-2 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">
                            <i class="fas fa-history text-primary ml-2"></i>
                            سجل الرسائل
                        </h2>
                        <div class="flex space-x-2 space-x-reverse">
                            <button id="refresh-messages" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 px-3 rounded-md transition duration-200">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button id="export-messages" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 flex items-center">
                                <i class="fas fa-file-export ml-2"></i>
                                <span class="hidden sm:inline">تصدير</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="responsive-table">
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">التاريخ</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">النوع</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">المحتوى</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">المستلمون</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">الحالة</th>
                                </tr>
                            </thead>
                            <tbody id="messages-table">
                                <!-- سيتم إضافة صفوف الرسائل هنا ديناميكياً -->
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                        <div class="flex justify-center">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                        </div>
                                        <p class="mt-2">جاري تحميل البيانات...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- تبويب الإحصائيات -->
        <section id="stats-tab" class="tab-content hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- بطاقات ملخص الإحصائيات -->
                <div class="grid grid-cols-1 gap-4 md:col-span-1">
                    <!-- عدد الطلاب -->
                    <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="flex items-center">
                            <div class="bg-blue-100 dark:bg-blue-900 p-3 rounded-full">
                                <i class="fas fa-user-graduate text-blue-500 dark:text-blue-300 text-xl"></i>
                            </div>
                            <div class="mx-4">
                                <p class="text-gray-500 dark:text-gray-400 text-sm stat-title">إجمالي الطلاب</p>
                                <p class="text-2xl font-bold stat-value" id="total-students">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- عدد الرسائل -->
                    <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="flex items-center">
                            <div class="bg-green-100 dark:bg-green-900 p-3 rounded-full">
                                <i class="fab fa-whatsapp text-green-500 dark:text-green-300 text-xl"></i>
                            </div>
                            <div class="mx-4">
                                <p class="text-gray-500 dark:text-gray-400 text-sm stat-title">الرسائل المرسلة</p>
                                <p class="text-2xl font-bold stat-value" id="total-messages">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- إحصائيات الأسبوع -->
                    <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <div class="flex items-center">
                            <div class="bg-purple-100 dark:bg-purple-900 p-3 rounded-full">
                                <i class="fas fa-calendar-week text-purple-500 dark:text-purple-300 text-xl"></i>
                            </div>
                            <div class="mx-4">
                                <p class="text-gray-500 dark:text-gray-400 text-sm stat-title">رسائل هذا الأسبوع</p>
                                <p class="text-2xl font-bold stat-value" id="weekly-messages">0</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- تصفية حسب التاريخ -->
                    <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                        <h3 class="font-bold mb-3">تصفية حسب التاريخ</h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">من</label>
                                <input type="date" id="date-from" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">إلى</label>
                                <input type="date" id="date-to" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                            </div>
                        </div>
                        <button id="filter-stats" class="w-full mt-3 bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                            <i class="fas fa-filter ml-2"></i>تصفية
                        </button>
                    </div>
                </div>
                
                <!-- الرسوم البيانية والإحصائيات التفصيلية -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow md:col-span-2">
                    <h2 class="text-lg font-bold mb-4">
                        <i class="fas fa-chart-bar text-primary ml-2"></i>
                        إحصائيات التواصل
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <!-- مخطط أنواع الرسائل -->
                        <div>
                            <h3 class="text-md font-semibold mb-2">أنواع الرسائل</h3>
                            <div class="relative h-60">
                                <canvas id="message-types-chart"></canvas>
                            </div>
                        </div>
                        
                        <!-- مخطط نشاط الأسبوع -->
                        <div>
                            <h3 class="text-md font-semibold mb-2">نشاط الأسبوع</h3>
                            <div class="relative h-60">
                                <canvas id="weekly-activity-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h3 class="text-md font-semibold mb-2">توزيع المراسلات حسب الصف</h3>
                        <div class="relative h-60">
                            <canvas id="grade-distribution-chart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- تبويب التقارير -->
        <section id="reports-tab" class="tab-content hidden fade-in">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <!-- خيارات التقارير -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <h2 class="text-lg font-bold mb-4">
                        <i class="fas fa-file-export text-primary ml-2"></i>
                        إنشاء تقرير
                    </h2>
                    
                    <form id="report-form" class="space-y-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">نوع التقرير</label>
                            <select id="report-type" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="students">بيانات الطلاب</option>
                                <option value="messages">سجل الرسائل</option>
                                <option value="stats">إحصائيات التواصل</option>
                                <option value="weekly">تقرير أسبوعي</option>
                            </select>
                        </div>
                        
                        <div id="report-date-range">
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">من</label>
                                    <input type="date" id="report-date-from" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">إلى</label>
                                    <input type="date" id="report-date-to" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                                </div>
                            </div>
                        </div>
                        
                        <div id="report-grade-filter">
                            <label class="block text-sm font-medium mb-1">تصفية حسب الصف (اختياري)</label>
                            <select id="report-grade" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="">كل الصفوف</option>
                                <option value="روضة أولى">روضة أولى (KG1)</option>
                                <option value="روضة ثانية">روضة ثانية (KG2)</option>
                                <option value="الأول">الأول</option>
                                <option value="الثاني">الثاني</option>
                                <option value="الثالث">الثالث</option>
                                <option value="الرابع">الرابع</option>
                                <option value="الخامس">الخامس</option>
                                <option value="السادس">السادس</option>
                                <option value="السابع">السابع</option>
                                <option value="الثامن">الثامن</option>
                                <option value="التاسع">التاسع</option>
                                <option value="العاشر">العاشر</option>
                                <option value="الحادي عشر">الحادي عشر</option>
                                <option value="الثاني عشر">الثاني عشر</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">صيغة التقرير</label>
                            <select id="report-format" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                <option value="excel">Excel</option>
                                <option value="csv">CSV</option>
                            </select>
                        </div>
                        
                        <div class="pt-2">
                            <button type="submit" class="w-full bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                                <i class="fas fa-download ml-2"></i>إنشاء التقرير
                            </button>
                        </div>
                    </form>
                </div>
                
                <!-- التقارير السابقة -->
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow md:col-span-2">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">
                            <i class="fas fa-history text-primary ml-2"></i>
                            التقارير السابقة
                        </h2>
                    </div>
                    
                    <div class="responsive-table">
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">التاريخ</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">نوع التقرير</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">الفترة</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">الصيغة</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="reports-table">
                                <!-- سيتم إضافة صفوف التقارير هنا ديناميكيًا -->
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                        <div class="flex justify-center">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                        </div>
                                        <p class="mt-2">جاري تحميل البيانات...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- تبويب الرسائل المجدولة -->
        <section id="scheduled-tab" class="tab-content hidden fade-in">
            <div class="grid grid-cols-1 gap-4 mb-6">
                <div class="card bg-white dark:bg-gray-800 rounded-lg p-4 shadow">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">
                            <i class="fas fa-calendar-alt text-primary ml-2"></i>
                            الرسائل المجدولة
                        </h2>
                        <button id="refresh-scheduled" class="bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-700 dark:text-gray-200 py-2 px-3 rounded-md transition duration-200">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    
                    <div class="responsive-table">
                        <table class="min-w-full border-collapse">
                            <thead>
                                <tr class="bg-gray-100 dark:bg-gray-700">
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">موعد الإرسال</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">المحتوى</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">المستلمون</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">الحالة</th>
                                    <th class="py-2 px-3 text-right border-b dark:border-gray-600">إجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="scheduled-messages-table">
                                <!-- سيتم إضافة صفوف الرسائل المجدولة هنا ديناميكياً -->
                                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                        <div class="flex justify-center">
                                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                        </div>
                                        <p class="mt-2">جاري تحميل البيانات...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- نوافذ الحوار -->
    <!-- نافذة تعديل بيانات الطالب -->
    <div id="edit-student-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-900 dark:opacity-80"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="mb-4">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            تعديل بيانات الطالب
                        </h3>
                    </div>
                    <form id="edit-student-form" class="space-y-3">
                        <input type="hidden" id="edit-student-id">
                        <div>
                            <label class="block text-sm font-medium mb-1">اسم الطالب*</label>
                            <input type="text" id="edit-student-name" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">الصف*</label>
                                <select id="edit-grade" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">اختر الصف</option>
                                    <option value="روضة أولى">روضة أولى (KG1)</option>
                                    <option value="روضة ثانية">روضة ثانية (KG2)</option>
                                    <option value="الأول">الأول</option>
                                    <option value="الثاني">الثاني</option>
                                    <option value="الثالث">الثالث</option>
                                    <option value="الرابع">الرابع</option>
                                    <option value="الخامس">الخامس</option>
                                    <option value="السادس">السادس</option>
                                    <option value="السابع">السابع</option>
                                    <option value="الثامن">الثامن</option>
                                    <option value="التاسع">التاسع</option>
                                    <option value="العاشر">العاشر</option>
                                    <option value="الحادي عشر">الحادي عشر</option>
                                    <option value="الثاني عشر">الثاني عشر</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">الفصل*</label>
                                <select id="edit-class-room" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">اختر الفصل</option>
                                    <option value="أ">أ</option>
                                    <option value="ب">ب</option>
                                    <option value="ج">ج</option>
                                    <option value="د">د</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">الفصل الدراسي*</label>
                                <select id="edit-semester" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">اختر الفصل الدراسي</option>
                                    <option value="الأول">الأول</option>
                                    <option value="الثاني">الثاني</option>
                                    <option value="الثالث">الثالث</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">الجنس*</label>
                                <select id="edit-gender" required class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                                    <option value="">اختر الجنس</option>
                                    <option value="ذكر">ذكر</option>
                                    <option value="أنثى">أنثى</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">المنطقة</label>
                            <input type="text" id="edit-region" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">رقم هاتف ولي الأمر*</label>
                            <input type="tel" id="edit-parent-phone" required placeholder="مثال: 971512345678" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">أدخل رقم الهاتف مع كود الدولة (مثال: 971512345678)</p>
                        </div>
                    </form>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="save-edit-student" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mr-3 sm:w-auto sm:text-sm">
                        حفظ التغييرات
                    </button>
                    <button type="button" id="cancel-edit-student" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-700">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد الحذف -->
    <div id="delete-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-900 dark:opacity-80"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="sm:flex sm:items-start">
                        <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
                            <i class="fas fa-exclamation-triangle text-red-600"></i>
                        </div>
                        <div class="mt-3 text-center sm:mt-0 sm:mr-4 sm:text-right">
                            <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white" id="delete-modal-title">
                                حذف طالب
                            </h3>
                            <div class="mt-2">
                                <p class="text-sm text-gray-500 dark:text-gray-400" id="delete-modal-text">
                                    هل أنت متأكد من رغبتك في حذف هذا الطالب؟ لا يمكن التراجع عن هذا الإجراء.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="confirm-delete" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:mr-3 sm:w-auto sm:text-sm">
                        حذف
                    </button>
                    <button type="button" id="cancel-delete" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-700">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة الإعدادات -->
    <div id="settings-modal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-medium text-gray-900 dark:text-white">إعدادات النظام</h3>
                    <button id="close-settings" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="settings-section">
                    <h4 class="settings-heading">رقم الواتساب المرسل</h4>
                    <div class="flex items-center mt-2">
                        <input type="tel" id="sender-phone" placeholder="رقم هاتف المدرسة مع كود الدولة (مثال: 971512345678)" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">أدخل رقم هاتف المدرسة مع كود الدولة (مثال: 971512345678). سيظهر هذا الرقم للمستلمين كمصدر للرسائل.</p>
                </div>
                
                <div class="settings-section">
                    <h4 class="settings-heading">إعدادات الإرسال</h4>
                    <div class="flex items-center mt-2">
                        <input type="checkbox" id="batch-sending" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                        <label for="batch-sending" class="mr-2 block text-sm">
                            إرسال الرسائل على دفعات (مناسب للعدد الكبير من المستلمين)
                        </label>
                    </div>
                    <div class="mt-2">
                        <label class="block text-sm font-medium mb-1">عدد الرسائل في كل دفعة</label>
                        <input type="number" id="batch-size" value="5" min="1" max="20" class="w-20 px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h4 class="settings-heading">توقيع الرسائل</h4>
                    <div class="mt-2">
                        <textarea id="message-signature" rows="2" placeholder="التوقيع الذي سيظهر في نهاية كل رسالة" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary text-base"></textarea>
                    </div>
                    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">سيتم إضافة هذا التوقيع تلقائياً في نهاية كل رسالة مرسلة.</p>
                </div>
                
                <div class="mt-5">
                    <button id="save-settings" class="w-full bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200 font-medium">
                        <i class="fas fa-save ml-2"></i>حفظ الإعدادات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة الملف المرفق -->
    <div id="file-preview-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-900 dark:opacity-80"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-medium text-gray-900 dark:text-white" id="preview-modal-title">
                            معاينة المرفق
                        </h3>
                        <button id="close-preview-modal" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="mt-2 text-center" id="preview-content">
                        <!-- سيتم إضافة محتوى المعاينة هنا -->
                    </div>
                </div>
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 flex justify-center">
                    <button type="button" id="close-preview-button" class="inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-700">
                        إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد الإرسال -->
    <div id="confirm-send-modal" class="confirm-backdrop hidden">
        <div class="confirm-dialog">
            <h3 class="text-lg font-bold mb-3">تأكيد إرسال الرسائل</h3>
            <p class="mb-3">أنت على وشك إرسال رسالة إلى <span id="recipient-count" class="font-bold"></span> مستلم. هل أنت متأكد من الاستمرار؟</p>
            <div class="confirm-actions">
                <button id="confirm-send-yes" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200">نعم، إرسال</button>
                <button id="confirm-send-no" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md transition duration-200">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة تأكيد اختبار الإرسال -->
    <div id="test-send-modal" class="confirm-backdrop hidden">
        <div class="confirm-dialog">
            <h3 class="text-lg font-bold mb-3">اختبار الإرسال</h3>
            <p class="mb-3">هل ترغب في إرسال رسالة اختبار أولاً للتأكد من عمل الإرسال بشكل صحيح؟</p>
            <div class="mt-3 mb-3">
                <label class="block text-sm font-medium mb-1">رقم هاتف الاختبار (اختياري)</label>
                <input type="tel" id="test-phone" placeholder="أدخل رقم الهاتف للاختبار" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-700 rounded-md dark:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-primary">
                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">إذا لم تدخل رقماً، سيتم استخدام رقم الواتساب المرسل من الإعدادات</p>
            </div>
            <div class="confirm-actions">
                <button id="test-send-yes" class="bg-primary hover:bg-secondary text-white py-2 px-4 rounded-md transition duration-200">اختبار الإرسال</button>
                <button id="test-send-skip" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded-md transition duration-200">تخطي والإرسال مباشرة</button>
                <button id="test-send-cancel" class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-2 px-4 rounded-md transition duration-200">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة وتأكيد استيراد ملف Excel (تظهر بعد اختيار الملف) -->
    <div id="excel-confirm-modal" class="fixed inset-0 z-50 hidden overflow-y-auto">
        <div class="flex items-center justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
            <div class="fixed inset-0 transition-opacity" aria-hidden="true">
                <div class="absolute inset-0 bg-gray-500 opacity-75 dark:bg-gray-900 dark:opacity-80"></div>
            </div>
            <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>
            <div class="inline-block align-bottom bg-white dark:bg-gray-800 rounded-lg text-right overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full">
                <div class="bg-white dark:bg-gray-800 px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
                    <div class="mb-4 flex justify-between">
                        <h3 class="text-lg leading-6 font-medium text-gray-900 dark:text-white">
                            معاينة بيانات الاستيراد
                        </h3>
                        <button id="close-excel-preview" class="text-gray-400 hover:text-gray-500 dark:hover:text-gray-300">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                        تم العثور على <span id="excel-row-count" class="font-semibold">0</span> صف في ملف Excel. يرجى تأكيد صحة البيانات ومطابقتها للحقول.
                    </p>
                    
                    <div class="responsive-table max-h-96 overflow-y-auto mb-4">
                        <table id="excel-data-table" class="min-w-full border-collapse">
                            <!-- سيتم إضافة جدول البيانات هنا -->
                        </table>
                    </div>
                </div>
                
                <div class="bg-gray-50 dark:bg-gray-700 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
                    <button type="button" id="import-excel-confirm" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-secondary focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mr-3 sm:w-auto sm:text-sm">
                        <i class="fas fa-file-import ml-2"></i> استيراد البيانات
                    </button>
                    <button type="button" id="cancel-excel-import" class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 sm:mt-0 sm:mr-3 sm:w-auto sm:text-sm dark:bg-gray-600 dark:text-white dark:border-gray-500 dark:hover:bg-gray-700">
                        إلغاء
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- إشعار النجاح (Toast) -->
    <div id="toast" class="fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white transition-all transform translate-y-12 opacity-0 duration-300 z-50 flex items-center">
        <i class="fas fa-check-circle ml-2"></i>
        <span id="toast-message"></span>
    </div>

    <!-- تذييل الصفحة -->
    <footer class="bg-white dark:bg-gray-800 py-4 text-center text-gray-600 dark:text-gray-400 text-sm border-t border-gray-200 dark:border-gray-700">
        <p>جميع الحقوق محفوظة - مدرسة  الثروات الوطنيه الخاصه © 2025</p>
        <p class="mt-1">تم التصميم من قبل المهندس حسين نقد 2025</p>
    </footer>

    <!-- منطق التطبيق -->
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyBwGgeiTIv9qvFVmDb7FXPv-mvqPaSJFWQ",
            authDomain: "twaslii7.firebaseapp.com",
            databaseURL: "https://twaslii7-default-rtdb.firebaseio.com",
            projectId: "twaslii7",
            storageBucket: "twaslii7.firebasestorage.app",
            messagingSenderId: "602453862624",
            appId: "1:602453862624:web:db438b0e5bb2315adc8885",
            measurementId: "G-BM7V8YS8N7"
            
        };

        // تهيئة التطبيق
        firebase.initializeApp(firebaseConfig);
        
        // الحصول على مراجع Firestore و Storage
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // مجموعات البيانات
        const studentsCollection = db.collection('students');
        const messagesCollection = db.collection('messages');
        const scheduledMessagesCollection = db.collection('scheduledMessages');
        const reportsCollection = db.collection('reports');
        const settingsCollection = db.collection('settings');
        
        // الإعدادات الافتراضية
        let appSettings = {
            senderPhone: '',
            batchSending: true,
            batchSize: 5,
            messageSignature: 'مدرسة الثروات الوطنيه الخاصه'
        };
        
        // متغيرات عامة
        let currentFileUpload = null;
        let messageTypesChart;
        let weeklyActivityChart;
        let gradeDistributionChart;
        let excelData = null; // لتخزين بيانات ملف Excel
        let excelColumns = []; // لتخزين أسماء الأعمدة في ملف Excel
        let excelColumnMapping = {}; // لتخزين تعيين أعمدة Excel إلى حقول الطلاب
        let currentImportStep = 1; // للتعامل مع خطوات الاستيراد
        
        // عناصر DOM
        const tabButtons = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        const darkModeToggle = document.getElementById('darkModeToggle');
        const studentsTable = document.getElementById('students-table');
        const studentForm = document.getElementById('student-form');
        const formMessage = document.getElementById('form-message');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toast-message');
        const messageForm = document.getElementById('message-form');
        const messageType = document.getElementById('message-type');
        const textMessageContainer = document.getElementById('text-message-container');
        const fileMessageContainer = document.getElementById('file-message-container');
        const messageStatus = document.getElementById('message-status');
        const messagesTable = document.getElementById('messages-table');
        const recipientsType = document.getElementById('recipients-type');
        const gradeFilter = document.getElementById('grade-filter');
        const classFilter = document.getElementById('class-filter');
        const individualFilter = document.getElementById('individual-filter');
        const studentsSelection = document.getElementById('students-selection');
        const searchStudent = document.getElementById('search-student');
        const editStudentModal = document.getElementById('edit-student-modal');
        const editStudentForm = document.getElementById('edit-student-form');
        const saveEditStudent = document.getElementById('save-edit-student');
        const cancelEditStudent = document.getElementById('cancel-edit-student');
        const deleteModal = document.getElementById('delete-modal');
        const confirmDelete = document.getElementById('confirm-delete');
        const cancelDelete = document.getElementById('cancel-delete');
        const refreshMessages = document.getElementById('refresh-messages');
        const exportStudents = document.getElementById('export-students');
        const exportMessages = document.getElementById('export-messages');
        const reportForm = document.getElementById('report-form');
        const filterStats = document.getElementById('filter-stats');
        const settingsButton = document.getElementById('settings-button');
        const settingsModal = document.getElementById('settings-modal');
        const closeSettings = document.getElementById('close-settings');
        const saveSettings = document.getElementById('save-settings');
        const senderPhone = document.getElementById('sender-phone');
        const batchSending = document.getElementById('batch-sending');
        const batchSize = document.getElementById('batch-size');
        const messageSignature = document.getElementById('message-signature');
        const toggleMessageTemplates = document.getElementById('toggle-message-templates');
        const messageTemplatesPanel = document.getElementById('message-templates-panel');
        const templateButtons = document.querySelectorAll('.template-button');
        const scheduleMessage = document.getElementById('schedule-message');
        const scheduleContainer = document.getElementById('schedule-container');
        const scheduleDate = document.getElementById('schedule-date');
        const scheduleTime = document.getElementById('schedule-time');
        const sendProgress = document.getElementById('send-progress');
        const sendProgressBar = document.getElementById('send-progress-bar');
        const sendProgressCurrent = document.getElementById('send-progress-current');
        const sendProgressTotal = document.getElementById('send-progress-total');
        const sendProgressPercent = document.getElementById('send-progress-percent');
        const sendProgressInfo = document.getElementById('send-progress-info');
        const refreshScheduled = document.getElementById('refresh-scheduled');
        const scheduledMessagesTable = document.getElementById('scheduled-messages-table');
        const sendMethodDirect = document.getElementById('send-method-direct');
        const sendMethodWeb = document.getElementById('send-method-web');
        const fileAttachment = document.getElementById('file-attachment');
        const fileUploadInfo = document.getElementById('file-upload-info');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const filePreview = document.getElementById('file-preview');
        const filePreviewModal = document.getElementById('file-preview-modal');
        const closePreviewModal = document.getElementById('close-preview-modal');
        const closePreviewButton = document.getElementById('close-preview-button');
        const previewContent = document.getElementById('preview-content');
        const selectAllStudents = document.getElementById('select-all-students');
        const deselectAllStudents = document.getElementById('deselect-all-students');
        const confirmSendModal = document.getElementById('confirm-send-modal');
        const recipientCount = document.getElementById('recipient-count');
        const confirmSendYes = document.getElementById('confirm-send-yes');
        const confirmSendNo = document.getElementById('confirm-send-no');
        const testSendModal = document.getElementById('test-send-modal');
        const testSendYes = document.getElementById('test-send-yes');
        const testSendSkip = document.getElementById('test-send-skip');
        const testSendCancel = document.getElementById('test-send-cancel');
        const testPhone = document.getElementById('test-phone');
        const useDelay = document.getElementById('use-delay');
        const delayOptions = document.getElementById('delay-options');
        const delaySeconds = document.getElementById('delay-seconds');
        
        // عناصر DOM الخاصة باستيراد Excel
        const toggleImport = document.getElementById('toggle-import');
        const manualEntry = document.getElementById('manual-entry');
        const excelImport = document.getElementById('excel-import');
        const excelFile = document.getElementById('excel-file');
        const excelFileInfo = document.getElementById('excel-file-info');
        const cancelImport = document.getElementById('cancel-import');
        const nextStep1 = document.getElementById('next-step-1');
        const backStep2 = document.getElementById('back-step-2');
        const nextStep2 = document.getElementById('next-step-2');
        const backStep3 = document.getElementById('back-step-3');
        const nextStep3 = document.getElementById('next-step-3');
        const backStep4 = document.getElementById('back-step-4');
        const importData = document.getElementById('import-data');
        const finishImport = document.getElementById('finish-import');
        const rowsCount = document.getElementById('rows-count');
        const excelPreview = document.getElementById('excel-preview');
        const validRowsCount = document.getElementById('valid-rows-count');
        const importSummary = document.getElementById('import-summary');
        const importProgressContainer = document.getElementById('import-progress-container');
        const importSuccess = document.getElementById('import-success');
        const importError = document.getElementById('import-error');
        const importProgressText = document.getElementById('import-progress-text');
        const importProgressBar = document.getElementById('import-progress-bar');
        const currentImported = document.getElementById('current-imported');
        const totalToImport = document.getElementById('total-to-import');
        const successCount = document.getElementById('success-count');
        const errorMessage = document.getElementById('error-message');
        
        // حفظ القيم المؤقتة للرسالة
        let tempMessageData = {
            type: '',
            content: '',
            fileUrl: '',
            recipients: '',
            scheduledDate: null,
            scheduledTime: null,
            sendMethod: 'direct',
            useDelay: false,
            delaySeconds: 3
        };
        
        // تهيئة التطبيق
        function initApp() {
            // تحميل الإعدادات
            loadSettings();
            
            // إعداد الوضع المظلم
            setupDarkMode();
            
            // إعداد التبويبات
            setupTabs();
            
            // تحميل جدول الطلاب
            loadStudentsTable();
            
            // تحميل جدول الرسائل
            loadMessagesTable();
            
            // تحميل جدول الرسائل المجدولة
            loadScheduledMessagesTable();
            
            // تحميل الإحصائيات
            loadStats();
            
            // تحميل جدول التقارير
            loadReportsTable();
            
            // إعداد مستمعي الأحداث
            setupEventListeners();
            
            // التحقق من الرسائل المجدولة
            checkScheduledMessages();
            setInterval(checkScheduledMessages, 60000); // التحقق كل دقيقة
        }
        
        // تحميل إعدادات التطبيق
        function loadSettings() {
            settingsCollection.doc('appSettings').get().then(doc => {
                if (doc.exists) {
                    appSettings = doc.data();
                } else {
                    // إنشاء إعدادات افتراضية إذا لم تكن موجودة
                    settingsCollection.doc('appSettings').set(appSettings);
                }
            }).catch(error => {
                console.error("خطأ في تحميل الإعدادات:", error);
            });
        }
        
        // إعداد مفتاح الوضع المظلم
        function setupDarkMode() {
            // تعيين الحالة الأولية بناءً على فئة المستند
            darkModeToggle.checked = document.documentElement.classList.contains('dark');
            
            // إضافة مستمع الحدث
            darkModeToggle.addEventListener('change', () => {
                if (darkModeToggle.checked) {
                    document.documentElement.classList.add('dark');
                } else {
                    document.documentElement.classList.remove('dark');
                }
                
                // إعادة رسم المخططات البيانية لتحديث مخطط الألوان
                if (messageTypesChart && weeklyActivityChart && gradeDistributionChart) {
                    updateCharts();
                }
            });
        }
        
        // إعداد التبويبات
        function setupTabs() {
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    // إزالة فئة active من كل التبويبات
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    
                    // إخفاء كل محتويات التبويبات
                    tabContents.forEach(content => content.classList.add('hidden'));
                    
                    // إظهار محتوى التبويب المحدد
                    const tabId = button.getAttribute('data-tab');
                    document.getElementById(`${tabId}-tab`).classList.remove('hidden');
                    
                    // تحديث المخططات البيانية إذا تم تحديد تبويب الإحصائيات
                    if (tabId === 'stats') {
                        updateCharts();
                    }
                });
            });
        }
        
        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            // إرسال نموذج الطالب
            studentForm.addEventListener('submit', (e) => {
                e.preventDefault();
                addStudent();
            });
            
            // تغيير نوع الرسالة
            messageType.addEventListener('change', () => {
                if (messageType.value === 'text') {
                    textMessageContainer.classList.remove('hidden');
                    fileMessageContainer.classList.add('hidden');
                } else {
                    textMessageContainer.classList.add('hidden');
                    fileMessageContainer.classList.remove('hidden');
                }
            });
            
            // تغيير نوع المستلمين
            recipientsType.addEventListener('change', () => {
                gradeFilter.classList.add('hidden');
                classFilter.classList.add('hidden');
                individualFilter.classList.add('hidden');
                
                if (recipientsType.value === 'grade') {
                    gradeFilter.classList.remove('hidden');
                } else if (recipientsType.value === 'class') {
                    classFilter.classList.remove('hidden');
                } else if (recipientsType.value === 'individual') {
                    individualFilter.classList.remove('hidden');
                    loadStudentsCheckboxes();
                }
            });
            
            // معالجة تحميل الملفات
            fileAttachment.addEventListener('change', handleFileUpload);
            
            // إرسال نموذج الرسالة
            messageForm.addEventListener('submit', (e) => {
                e.preventDefault();
                
                // التحقق من الحقول المطلوبة
                if (!validateMessageForm()) {
                    return;
                }
                
                // حفظ بيانات الرسالة مؤقتًا
                saveTempMessageData();
                
                // الحصول على المستلمين والتحقق منهم
                getPhoneNumbersFromRecipients(tempMessageData.recipients)
                    .then(phoneNumbers => {
                        if (phoneNumbers.length === 0) {
                            showMessageStatus('لا يوجد أرقام هواتف صالحة للإرسال. يرجى التحقق من بيانات المستلمين.', 'error');
                            return;
                        }
                        
                        // عرض عدد المستلمين في نافذة التأكيد
                        recipientCount.textContent = phoneNumbers.length;
                        
                        // عرض نافذة تأكيد الإرسال
                        confirmSendModal.classList.remove('hidden');
                    })
                    .catch(error => {
                        console.error("خطأ في التحقق من المستلمين:", error);
                        showMessageStatus('حدث خطأ أثناء التحقق من المستلمين. يرجى المحاولة مرة أخرى.', 'error');
                    });
            });
            
            // زر تأكيد الإرسال
            confirmSendYes.addEventListener('click', () => {
                confirmSendModal.classList.add('hidden');
                
                // فتح نافذة اختبار الإرسال
                testSendModal.classList.remove('hidden');
            });
            
            // زر إلغاء الإرسال
            confirmSendNo.addEventListener('click', () => {
                confirmSendModal.classList.add('hidden');
            });
            
            // زر اختبار الإرسال
            testSendYes.addEventListener('click', () => {
                testSendModal.classList.add('hidden');
                
                // إرسال رسالة اختبار
                sendTestMessage();
            });
            
            // زر تخطي الاختبار والإرسال مباشرة
            testSendSkip.addEventListener('click', () => {
                testSendModal.classList.add('hidden');
                
                // إرسال الرسالة مباشرة
                if (scheduleMessage.checked) {
                    scheduleWhatsAppMessage();
                } else {
                    sendWhatsAppMessage();
                }
            });
            
            // زر إلغاء اختبار الإرسال
            testSendCancel.addEventListener('click', () => {
                testSendModal.classList.add('hidden');
            });
            
            // خيار استخدام تأخير بين الرسائل
            useDelay.addEventListener('change', () => {
                if (useDelay.checked) {
                    delayOptions.classList.remove('hidden');
                } else {
                    delayOptions.classList.add('hidden');
                }
            });
            
            // البحث عن طالب
            searchStudent.addEventListener('input', () => {
                loadStudentsTable(searchStudent.value);
            });
            
            // إلغاء تعديل الطالب
            cancelEditStudent.addEventListener('click', () => {
                editStudentModal.classList.add('hidden');
            });
            
            // حفظ تعديل الطالب
            saveEditStudent.addEventListener('click', () => {
                saveEditedStudent();
            });
            
            // إلغاء الحذف
            cancelDelete.addEventListener('click', () => {
                deleteModal.classList.add('hidden');
            });
            
            // تأكيد الحذف
            confirmDelete.addEventListener('click', () => {
                const id = confirmDelete.getAttribute('data-id');
                const type = confirmDelete.getAttribute('data-type');
                
                if (type === 'student') {
                    deleteStudent(id);
                } else if (type === 'scheduled') {
                    deleteScheduledMessage(id);
                }
                
                deleteModal.classList.add('hidden');
            });
            
            // تحديث الرسائل
            refreshMessages.addEventListener('click', () => {
                loadMessagesTable();
                showToast('تم تحديث سجل الرسائل', 'success');
            });
            
            // تحديث الرسائل المجدولة
            refreshScheduled.addEventListener('click', () => {
                loadScheduledMessagesTable();
                showToast('تم تحديث قائمة الرسائل المجدولة', 'success');
            });
            
            // تصدير الطلاب
            exportStudents.addEventListener('click', () => {
                exportStudentsToExcel();
            });
            
            // تصدير الرسائل
            exportMessages.addEventListener('click', () => {
                exportMessagesToExcel();
            });
            
            // إرسال نموذج التقرير
            reportForm.addEventListener('submit', (e) => {
                e.preventDefault();
                generateReport();
            });
            
            // تصفية الإحصائيات
            filterStats.addEventListener('click', () => {
                const dateFrom = document.getElementById('date-from').value;
                const dateTo = document.getElementById('date-to').value;
                
                if (dateFrom && dateTo) {
                    loadStats({
                        dateFrom,
                        dateTo
                    });
                    showToast('تم تطبيق التصفية', 'success');
                } else {
                    showToast('يرجى تحديد نطاق التاريخ', 'error');
                }
            });
            
            // زر الإعدادات
            settingsButton.addEventListener('click', () => {
                // تحميل قيم الإعدادات
                senderPhone.value = appSettings.senderPhone || '';
                batchSending.checked = appSettings.batchSending || false;
                batchSize.value = appSettings.batchSize || 5;
                messageSignature.value = appSettings.messageSignature || '';
                
                // إظهار النافذة
                settingsModal.classList.add('show');
            });
            
            // إغلاق الإعدادات
            closeSettings.addEventListener('click', () => {
                settingsModal.classList.remove('show');
            });
            
            // حفظ الإعدادات
            saveSettings.addEventListener('click', () => {
                const newSettings = {
                    senderPhone: senderPhone.value,
                    batchSending: batchSending.checked,
                    batchSize: parseInt(batchSize.value),
                    messageSignature: messageSignature.value
                };
                
                // تحديث الإعدادات في Firestore
                settingsCollection.doc('appSettings').set(newSettings).then(() => {
                    appSettings = newSettings;
                    settingsModal.classList.remove('show');
                    showToast('تم حفظ الإعدادات بنجاح', 'success');
                }).catch(error => {
                    console.error("خطأ في حفظ الإعدادات:", error);
                    showToast('حدث خطأ أثناء حفظ الإعدادات', 'error');
                });
            });
            
            // تبديل لوحة قوالب الرسائل
            toggleMessageTemplates.addEventListener('click', () => {
                if (messageTemplatesPanel.classList.contains('hidden')) {
                    messageTemplatesPanel.classList.remove('hidden');
                } else {
                    messageTemplatesPanel.classList.add('hidden');
                }
            });
            
            // أزرار القوالب
            templateButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const template = button.getAttribute('data-template');
                    const messageTextInput = document.getElementById('message-text');
                    messageTextInput.value = template;
                    
                    // إخفاء لوحة القوالب
                    messageTemplatesPanel.classList.add('hidden');
                });
            });
            
            // التبديل بين الإرسال الفوري والجدولة
            scheduleMessage.addEventListener('change', () => {
                if (scheduleMessage.checked) {
                    scheduleContainer.classList.remove('hidden');
                    
                    // تعيين تاريخ/وقت افتراضي (غدًا، 9 صباحًا)
                    const tomorrow = new Date();
                    tomorrow.setDate(tomorrow.getDate() + 1);
                    tomorrow.setHours(9, 0, 0, 0);
                    
                    const dateStr = tomorrow.toISOString().split('T')[0];
                    scheduleDate.value = dateStr;
                    scheduleTime.value = '09:00';
                } else {
                    scheduleContainer.classList.add('hidden');
                }
            });
            
            // إغلاق نافذة معاينة الملف
            closePreviewModal.addEventListener('click', () => {
                filePreviewModal.classList.add('hidden');
            });
            
            // إغلاق نافذة معاينة الملف (زر الإغلاق)
            closePreviewButton.addEventListener('click', () => {
                filePreviewModal.classList.add('hidden');
            });
            
            // تحديد كل الطلاب
            selectAllStudents.addEventListener('click', () => {
                document.querySelectorAll('#students-selection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = true;
                });
            });
            
            // إلغاء تحديد كل الطلاب
            deselectAllStudents.addEventListener('click', () => {
                document.querySelectorAll('#students-selection input[type="checkbox"]').forEach(checkbox => {
                    checkbox.checked = false;
                });
            });
            
            // النقر خارج نافذة الإعدادات لإغلاقها
            window.addEventListener('click', (e) => {
                if (e.target === settingsModal) {
                    settingsModal.classList.remove('show');
                }
                if (e.target === filePreviewModal) {
                    filePreviewModal.classList.add('hidden');
                }
                if (e.target === confirmSendModal) {
                    confirmSendModal.classList.add('hidden');
                }
                if (e.target === testSendModal) {
                    testSendModal.classList.add('hidden');
                }
            });
            
            // استيراد Excel - تبديل بين الإدخال اليدوي واستيراد Excel
            toggleImport.addEventListener('click', () => {
                if (manualEntry.classList.contains('hidden')) {
                    // العودة إلى الإدخال اليدوي
                    manualEntry.classList.remove('hidden');
                    excelImport.classList.add('hidden');
                    toggleImport.innerHTML = '<i class="fas fa-file-excel ml-1"></i> استيراد من Excel';
                } else {
                    // التبديل إلى استيراد Excel
                    manualEntry.classList.add('hidden');
                    excelImport.classList.remove('hidden');
                    toggleImport.innerHTML = '<i class="fas fa-user-plus ml-1"></i> إدخال يدوي';
                    
                    // تعيين الخطوة الأولى كنشطة
                    showImportStep(1);
                }
            });
            
            // التعامل مع تحميل ملف Excel
            excelFile.addEventListener('change', handleExcelFileUpload);
            
            // إلغاء الاستيراد
            cancelImport.addEventListener('click', () => {
                manualEntry.classList.remove('hidden');
                excelImport.classList.add('hidden');
                toggleImport.innerHTML = '<i class="fas fa-file-excel ml-1"></i> استيراد من Excel';
                
                // إعادة تعيين البيانات
                excelData = null;
                excelColumns = [];
                excelColumnMapping = {};
                excelFile.value = '';
                excelFileInfo.classList.add('hidden');
                nextStep1.disabled = true;
                nextStep1.classList.add('opacity-50', 'cursor-not-allowed');
            });
            
            // الانتقال من الخطوة 1 إلى 2
            nextStep1.addEventListener('click', () => {
                if (!nextStep1.disabled) {
                    showImportStep(2);
                    showExcelPreview();
                }
            });
            
            // العودة من الخطوة 2 إلى 1
            backStep2.addEventListener('click', () => {
                showImportStep(1);
            });
            
            // الانتقال من الخطوة 2 إلى 3
            nextStep2.addEventListener('click', () => {
                showImportStep(3);
                prepareColumnMapping();
            });
            
            // العودة من الخطوة 3 إلى 2
            backStep3.addEventListener('click', () => {
                showImportStep(2);
            });
            
            // الانتقال من الخطوة 3 إلى 4
            nextStep3.addEventListener('click', () => {
                if (validateColumnMapping()) {
                    showImportStep(4);
                    prepareImportSummary();
                } else {
                    showToast('يرجى ربط جميع الحقول المطلوبة', 'error');
                }
            });
            
            // العودة من الخطوة 4 إلى 3
            backStep4.addEventListener('click', () => {
                showImportStep(3);
            });
            
            // بدء استيراد البيانات
            importData.addEventListener('click', () => {
                showImportStep(5);
                importStudentsFromExcel();
            });
            
            // إنهاء عملية الاستيراد
            finishImport.addEventListener('click', () => {
                manualEntry.classList.remove('hidden');
                excelImport.classList.add('hidden');
                toggleImport.innerHTML = '<i class="fas fa-file-excel ml-1"></i> استيراد من Excel';
                
                // إعادة تعيين البيانات
                excelData = null;
                excelColumns = [];
                excelColumnMapping = {};
                excelFile.value = '';
                excelFileInfo.classList.add('hidden');
                
                // تحديث جدول الطلاب
                loadStudentsTable();
            });
        }
        
        // عرض خطوة الاستيراد المحددة
        function showImportStep(step) {
            // إخفاء جميع الخطوات
            document.querySelectorAll('.import-step').forEach(el => {
                el.classList.remove('active');
            });
            
            // إظهار الخطوة المحددة
            document.getElementById(`step-${step}`).classList.add('active');
            
            // تحديث الخطوة الحالية
            currentImportStep = step;
        }
        
        // معالجة تحميل ملف Excel
        function handleExcelFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // تحقق من نوع الملف
            if (!file.name.match(/\.(xlsx|xls)$/i)) {
                showToast('يجب اختيار ملف Excel (بامتداد .xlsx أو .xls)', 'error');
                excelFile.value = '';
                return;
            }
            
            // عرض اسم الملف
            const fileNameEl = excelFileInfo.querySelector('.file-name') || excelFileInfo;
            fileNameEl.textContent = file.name;
            excelFileInfo.classList.remove('hidden');
            
            // قراءة ملف Excel
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const data = new Uint8Array(event.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    
                    // الحصول على اسم الورقة الأولى
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    
                    // تحويل البيانات إلى JSON
                    excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                    
                    // التحقق من وجود بيانات
                    if (excelData && excelData.length > 1) {
                        // الحصول على أسماء الأعمدة (الصف الأول)
                        excelColumns = excelData[0];
                        
                        // تفعيل زر الخطوة التالية
                        nextStep1.disabled = false;
                        nextStep1.classList.remove('opacity-50', 'cursor-not-allowed');
                        
                        showToast(`تم تحميل ملف Excel بنجاح. يحتوي على ${excelData.length - 1} صف من البيانات.`, 'success');
                    } else {
                        showToast('ملف Excel فارغ أو لا يحتوي على بيانات كافية.', 'error');
                        excelFile.value = '';
                        excelFileInfo.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('خطأ في قراءة ملف Excel:', error);
                    showToast('حدث خطأ أثناء قراءة ملف Excel. يرجى التأكد من صحة الملف.', 'error');
                    excelFile.value = '';
                    excelFileInfo.classList.add('hidden');
                }
            };
            
            reader.onerror = () => {
                showToast('حدث خطأ أثناء قراءة الملف.', 'error');
                excelFile.value = '';
                excelFileInfo.classList.add('hidden');
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        // عرض معاينة بيانات Excel
        function showExcelPreview() {
            if (!excelData || excelData.length <= 1) {
                showToast('لا توجد بيانات لعرضها', 'error');
                return;
            }
            
            // تحديث عدد الصفوف
            rowsCount.textContent = excelData.length - 1;
            
            // بناء جدول المعاينة
            let theadHTML = '<tr class="bg-gray-100 dark:bg-gray-700">';
            for (let i = 0; i < excelColumns.length; i++) {
                theadHTML += `<th class="py-2 px-3 text-right border-b dark:border-gray-600">${excelColumns[i]}</th>`;
            }
            theadHTML += '</tr>';
            
            let tbodyHTML = '';
            // عرض 10 صفوف كحد أقصى للمعاينة
            const rowsToShow = Math.min(excelData.length - 1, 10);
            for (let i = 1; i <= rowsToShow; i++) {
                tbodyHTML += '<tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">';
                for (let j = 0; j < excelColumns.length; j++) {
                    const cellValue = excelData[i][j] !== undefined ? excelData[i][j] : '';
                    tbodyHTML += `<td class="py-2 px-3">${cellValue}</td>`;
                }
                tbodyHTML += '</tr>';
            }
            
            // إضافة صف إضافي إذا كان هناك المزيد من البيانات
            if (excelData.length - 1 > 10) {
                tbodyHTML += `
                    <tr class="border-b dark:border-gray-700">
                        <td colspan="${excelColumns.length}" class="py-2 px-3 text-center text-gray-500 dark:text-gray-400">
                            ... المزيد من البيانات (${excelData.length - 11} صف إضافي)
                        </td>
                    </tr>
                `;
            }
            
            // تحديث جدول المعاينة
            excelPreview.querySelector('thead').innerHTML = theadHTML;
            excelPreview.querySelector('tbody').innerHTML = tbodyHTML;
        }
        
        // إعداد خيارات ربط الأعمدة
        function prepareColumnMapping() {
            if (!excelColumns || excelColumns.length === 0) return;
            
            // إنشاء خيارات الأعمدة لكل قائمة منسدلة
            const selectFields = [
                'map-student-id', 'map-student-name', 'map-grade', 'map-class-room', 
                'map-semester', 'map-gender', 'map-region', 'map-parent-phone'
            ];
            
            selectFields.forEach(fieldId => {
                const select = document.getElementById(fieldId);
                select.innerHTML = '<option value="">اختر العمود المقابل</option>';
                
                // إضافة خيارات الأعمدة
                excelColumns.forEach((column, index) => {
                    const option = document.createElement('option');
                    option.value = index;
                    option.textContent = column;
                    select.appendChild(option);
                });
                
                // محاولة التطابق التلقائي
                autoMapColumn(fieldId);
                
                // حفظ التغييرات عند اختيار عمود
                select.addEventListener('change', () => {
                    if (select.value) {
                        excelColumnMapping[fieldId.replace('map-', '')] = parseInt(select.value);
                    } else {
                        delete excelColumnMapping[fieldId.replace('map-', '')];
                    }
                });
            });
        }
        
        // محاولة التطابق التلقائي للأعمدة
        function autoMapColumn(fieldId) {
            const select = document.getElementById(fieldId);
            const fieldName = fieldId.replace('map-', '');
            
            // قائمة الكلمات المفتاحية للبحث لكل حقل
            const keywordMap = {
                'student-id': ['رقم', 'اسيس', 'id', 'student id', 'رقم الطالب', 'رقم الاسيس'],
                'student-name': ['اسم', 'الطالب', 'name', 'student name', 'اسم الطالب'],
                'grade': ['صف', 'الصف', 'grade', 'class', 'الصف الدراسي'],
                'class-room': ['فصل', 'شعبة', 'الفصل', 'الشعبة', 'room', 'section'],
                'semester': ['الفصل الدراسي', 'ترم', 'فصل دراسي', 'semester', 'term'],
                'gender': ['جنس', 'الجنس', 'نوع', 'ذكر/أنثى', 'gender', 'sex'],
                'region': ['منطقة', 'المنطقة', 'عنوان', 'العنوان', 'region', 'address'],
                'parent-phone': ['هاتف', 'جوال', 'رقم الهاتف', 'رقم الجوال', 'phone', 'mobile', 'رقم ولي الأمر', 'هاتف ولي الأمر']
            };
            
            // البحث عن تطابق
            for (let i = 0; i < excelColumns.length; i++) {
                const columnName = excelColumns[i].toString().toLowerCase();
                
                // التحقق من كل كلمة مفتاحية
                if (keywordMap[fieldName].some(keyword => columnName.includes(keyword.toLowerCase()))) {
                    select.value = i;
                    excelColumnMapping[fieldName] = i;
                    break;
                }
            }
        }
        
        // التحقق من صحة ربط الأعمدة
        function validateColumnMapping() {
            // الحقول الإلزامية
            const requiredFields = [
                'student-id', 'student-name', 'grade', 'class-room', 
                'semester', 'gender', 'parent-phone'
            ];
            
            // التحقق من وجود جميع الحقول الإلزامية
            for (const field of requiredFields) {
                if (excelColumnMapping[field] === undefined) {
                    return false;
                }
            }
            
            return true;
        }
        
        // إعداد ملخص الاستيراد
        function prepareImportSummary() {
            if (!excelData || excelData.length <= 1) return;
            
            let validRowsCountValue = 0;
            let summaryHTML = '';
            
            // التحقق من كل صف
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                let isValidRow = true;
                
                // التحقق من وجود البيانات الإلزامية
                const studentId = row[excelColumnMapping['student-id']];
                const studentName = row[excelColumnMapping['student-name']];
                const grade = row[excelColumnMapping['grade']];
                const classRoom = row[excelColumnMapping['class-room']];
                const semester = row[excelColumnMapping['semester']];
                const gender = row[excelColumnMapping['gender']];
                const parentPhone = row[excelColumnMapping['parent-phone']];
                
                if (!studentId || !studentName || !grade || !classRoom || !semester || !gender || !parentPhone) {
                    isValidRow = false;
                }
                
                // التحقق من صحة رقم الهاتف
                if (parentPhone && !isValidPhoneNumber(parentPhone.toString())) {
                    isValidRow = false;
                }
                
                if (isValidRow) {
                    validRowsCountValue++;
                }
            }
            
            // تحديث عدد الصفوف الصالحة
            validRowsCount.textContent = validRowsCountValue;
            
            // إضافة ملخص
            summaryHTML += `<li>إجمالي عدد الصفوف: ${excelData.length - 1}</li>`;
            summaryHTML += `<li>عدد الصفوف الصالحة للاستيراد: ${validRowsCountValue}</li>`;
            
            if (validRowsCountValue < excelData.length - 1) {
                summaryHTML += `<li class="text-yellow-500 dark:text-yellow-400">تم تجاهل ${excelData.length - 1 - validRowsCountValue} صف بسبب بيانات غير مكتملة أو غير صالحة</li>`;
            }
            
            // تعيين تخطيط الأعمدة
            summaryHTML += '<li class="mt-3 font-semibold">تخطيط الحقول:</li>';
            const fieldLabels = {
                'student-id': 'رقم الاسيس',
                'student-name': 'اسم الطالب',
                'grade': 'الصف',
                'class-room': 'الفصل',
                'semester': 'الفصل الدراسي',
                'gender': 'الجنس',
                'region': 'المنطقة',
                'parent-phone': 'رقم هاتف ولي الأمر'
            };
            
            for (const [field, index] of Object.entries(excelColumnMapping)) {
                const columnName = excelColumns[index];
                summaryHTML += `<li class="mr-4"><span class="mapping-field">${fieldLabels[field]}</span> ← ${columnName}</li>`;
            }
            
            importSummary.innerHTML = summaryHTML;
        }
        
        // استيراد الطلاب من ملف Excel
        async function importStudentsFromExcel() {
            if (!excelData || excelData.length <= 1) {
                showImportError("لا توجد بيانات لاستيرادها");
                return;
            }
            
            // تهيئة واجهة التقدم
            importProgressContainer.classList.remove('hidden');
            importSuccess.classList.add('hidden');
            importError.classList.add('hidden');
            
            // حساب عدد الصفوف الصالحة
            let rowsToImport = [];
            
            for (let i = 1; i < excelData.length; i++) {
                const row = excelData[i];
                let isValidRow = true;
                
                // التحقق من وجود البيانات الإلزامية
                const studentId = row[excelColumnMapping['student-id']];
                const studentName = row[excelColumnMapping['student-name']];
                const grade = row[excelColumnMapping['grade']];
                const classRoom = row[excelColumnMapping['class-room']];
                const semester = row[excelColumnMapping['semester']];
                const gender = row[excelColumnMapping['gender']];
                const parentPhone = row[excelColumnMapping['parent-phone']];
                
                if (!studentId || !studentName || !grade || !classRoom || !semester || !gender || !parentPhone) {
                    isValidRow = false;
                }
                
                // التحقق من صحة رقم الهاتف
                if (parentPhone && !isValidPhoneNumber(parentPhone.toString())) {
                    isValidRow = false;
                }
                
                if (isValidRow) {
                    rowsToImport.push({
                        row,
                        index: i
                    });
                }
            }
            
            // تحديث إجمالي العدد
            totalToImport.textContent = rowsToImport.length;
            
            // بدء الاستيراد
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < rowsToImport.length; i++) {
                const { row, index } = rowsToImport[i];
                
                // تحديث التقدم
                currentImported.textContent = i + 1;
                const progress = Math.round(((i + 1) / rowsToImport.length) * 100);
                importProgressBar.style.width = `${progress}%`;
                
                try {
                    // تجميع بيانات الطالب
                    const student = {
                        studentId: row[excelColumnMapping['student-id']].toString(),
                        name: row[excelColumnMapping['student-name']].toString(),
                        grade: row[excelColumnMapping['grade']].toString(),
                        classRoom: row[excelColumnMapping['class-room']].toString(),
                        semester: row[excelColumnMapping['semester']].toString(),
                        gender: row[excelColumnMapping['gender']].toString(),
                        parentPhone: row[excelColumnMapping['parent-phone']].toString(),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    
                    // إضافة المنطقة إذا وجدت
                    if (excelColumnMapping['region'] !== undefined && row[excelColumnMapping['region']]) {
                        student.region = row[excelColumnMapping['region']].toString();
                    }
                    
                    // التحقق من عدم وجود رقم أساس مكرر
                    const existingStudents = await studentsCollection.where('studentId', '==', student.studentId).get();
                    
                    if (!existingStudents.empty) {
                        // تخطي الصف لوجود رقم مكرر
                        console.warn(`رقم الاسيس مكرر للصف ${index}: ${student.studentId}`);
                        continue;
                    }
                    
                    // إضافة الطالب إلى Firebase
                    await studentsCollection.add(student);
                    successCount++;
                    
                    // انتظار وقت قصير بين الإضافات
                    if (i < rowsToImport.length - 1) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                } catch (error) {
                    console.error(`خطأ في استيراد الصف ${index}:`, error);
                    errorCount++;
                }
            }
            
            // إظهار النتائج
            importProgressContainer.classList.add('hidden');
            
            if (errorCount > 0 && successCount === 0) {
                // فشل كامل
                importError.classList.remove('hidden');
                errorMessage.textContent = `فشل استيراد البيانات. حدث ${errorCount} خطأ.`;
            } else {
                // نجاح (كلي أو جزئي)
                importSuccess.classList.remove('hidden');
                successCount.textContent = successCount;
                
                if (errorCount > 0) {
                    // نجاح جزئي
                    errorMessage.textContent = `تم استيراد ${successCount} طالب بنجاح، ولكن حدث ${errorCount} خطأ.`;
                    importError.classList.remove('hidden');
                }
            }
            
            // إظهار زر الإنهاء
            finishImport.classList.remove('hidden');
            
            // تحديث جدول الطلاب
            loadStudentsTable();
        }
        
        // عرض خطأ الاستيراد
        function showImportError(message) {
            importProgressContainer.classList.add('hidden');
            importSuccess.classList.add('hidden');
            importError.classList.remove('hidden');
            errorMessage.textContent = message;
            finishImport.classList.remove('hidden');
        }
        
        // التحقق من صحة نموذج الرسالة
        function validateMessageForm() {
            const type = messageType.value;
            
            if (type === 'text') {
                const messageText = document.getElementById('message-text').value.trim();
                if (!messageText) {
                    showMessageStatus('يرجى إدخال نص الرسالة', 'error');
                    return false;
                }
            } else { // file
                if (!currentFileUpload) {
                    showMessageStatus('يرجى رفع ملف أولاً', 'error');
                    return false;
                }
            }
            
            if (recipientsType.value === 'individual') {
                const hasCheckedRecipients = document.querySelectorAll('#students-selection input[type="checkbox"]:checked').length > 0;
                if (!hasCheckedRecipients) {
                    showMessageStatus('يرجى اختيار طالب واحد على الأقل', 'error');
                    return false;
                }
            }
            
            if (scheduleMessage.checked) {
                const scheduledDate = document.getElementById('schedule-date').value;
                const scheduledTime = document.getElementById('schedule-time').value;
                
                if (!scheduledDate || !scheduledTime) {
                    showMessageStatus('يرجى تحديد التاريخ والوقت للجدولة', 'error');
                    return false;
                }
                
                const scheduledFor = new Date(`${scheduledDate}T${scheduledTime}`);
                
                if (scheduledFor <= new Date()) {
                    showMessageStatus('يجب أن يكون موعد الجدولة في المستقبل', 'error');
                    return false;
                }
            }
            
            return true;
        }
        
        // حفظ بيانات الرسالة مؤقتًا
        function saveTempMessageData() {
            const type = messageType.value;
            let content = '';
            let fileUrl = '';
            
            if (type === 'text') {
                content = document.getElementById('message-text').value;
            } else {
                fileUrl = currentFileUpload ? currentFileUpload.url : '';
                content = document.getElementById('file-message-text').value || '';
            }
            
            // الحصول على المستلمين
            let recipients;
            const recipientsTypeValue = recipientsType.value;
            
            if (recipientsTypeValue === 'all') {
                recipients = 'all';
            } else if (recipientsTypeValue === 'grade') {
                const grade = document.getElementById('message-grade').value;
                recipients = 'grade:' + grade;
            } else if (recipientsTypeValue === 'class') {
                const grade = document.getElementById('class-grade').value;
                const classRoom = document.getElementById('class-section').value;
                recipients = 'class:' + grade + ':' + classRoom;
            } else if (recipientsTypeValue === 'individual') {
                const selectedStudents = [];
                document.querySelectorAll('#students-selection input[type="checkbox"]:checked').forEach(checkbox => {
                    selectedStudents.push(checkbox.value);
                });
                recipients = selectedStudents;
            }
            
            // حفظ البيانات مؤقتًا
            tempMessageData = {
                type,
                content,
                fileUrl,
                recipients,
                scheduledDate: scheduleMessage.checked ? scheduleDate.value : null,
                scheduledTime: scheduleMessage.checked ? scheduleTime.value : null,
                sendMethod: sendMethodDirect.checked ? 'direct' : 'web',
                useDelay: useDelay.checked,
                delaySeconds: parseInt(delaySeconds.value || '3')
            };
        }
        
        // معالجة رفع الملفات
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // عرض معلومات الملف
            const fileNameElement = fileUploadInfo.querySelector('.file-name');
            const progressBar = fileUploadInfo.querySelector('.upload-progress-value');
            
            fileNameElement.textContent = file.name;
            progressBar.style.width = '0%';
            fileUploadInfo.classList.remove('hidden');
            
            // تحديد نوع الملف
            const fileType = document.getElementById('file-type').value;
            
            // التحقق من امتداد الملف
            let validExtensions = [];
            switch (fileType) {
                case 'pdf':
                    validExtensions = ['.pdf'];
                    break;
                case 'image':
                    validExtensions = ['.jpg', '.jpeg', '.png', '.gif'];
                    break;
                case 'excel':
                    validExtensions = ['.xls', '.xlsx'];
                    break;
                case 'word':
                    validExtensions = ['.doc', '.docx'];
                    break;
            }
            
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            if (!validExtensions.includes(fileExt)) {
                fileNameElement.innerHTML = `<span class="text-red-500">الملف غير صالح. يرجى اختيار ملف من النوع: ${validExtensions.join(', ')}</span>`;
                progressBar.style.width = '0%';
                return;
            }
            
            // عرض معاينة الصورة إذا كان الملف صورة
            if (fileType === 'image') {
                const reader = new FileReader();
                reader.onload = function(e) {
                    filePreview.src = e.target.result;
                    filePreviewContainer.classList.remove('hidden');
                }
                reader.readAsDataURL(file);
            } else {
                filePreviewContainer.classList.add('hidden');
            }
            
            // رفع الملف إلى Firebase Storage
            const storageRef = storage.ref();
            const fileRef = storageRef.child(`attachments/${Date.now()}_${file.name}`);
            const uploadTask = fileRef.put(file);
            
            // متابعة تقدم الرفع
            uploadTask.on('state_changed', 
                (snapshot) => {
                    // حساب نسبة التقدم
                    const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    progressBar.style.width = progress + '%';
                }, 
                (error) => {
                    // التعامل مع الأخطاء
                    fileNameElement.innerHTML = `<span class="text-red-500">حدث خطأ أثناء رفع الملف: ${error.message}</span>`;
                    progressBar.style.width = '0%';
                }, 
                () => {
                    // اكتمال الرفع بنجاح
                    uploadTask.snapshot.ref.getDownloadURL().then((downloadURL) => {
                        fileNameElement.innerHTML = `<span class="text-green-500">تم رفع الملف بنجاح!</span>`;
                        progressBar.style.width = '100%';
                        
                        // تخزين معلومات الملف المرفوع
                        currentFileUpload = {
                            name: file.name,
                            type: fileType,
                            url: downloadURL
                        };
                    });
                }
            );
        }
        
        // تحميل جدول الطلاب
        function loadStudentsTable(search = '') {
            let query = studentsCollection;
            
            // عرض حالة التحميل
            studentsTable.innerHTML = `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        </div>
                        <p class="mt-2">جاري تحميل البيانات...</p>
                    </td>
                </tr>
            `;
            
            // جلب البيانات من Firestore
            query.get().then((querySnapshot) => {
                if (querySnapshot.empty) {
                    studentsTable.innerHTML = `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                لا يوجد طلاب مسجلين حالياً
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // تجميع البيانات وتطبيق البحث إذا وجد
                let students = [];
                querySnapshot.forEach((doc) => {
                    const student = { id: doc.id, ...doc.data() };
                    
                    // تطبيق البحث إذا كان هناك نص بحث
                    if (search) {
                        const searchLower = search.toLowerCase();
                        if (
                            student.name.toLowerCase().includes(searchLower) || 
                            student.studentId.toString().includes(searchLower) ||
                            student.parentPhone.includes(search)
                        ) {
                            students.push(student);
                        }
                    } else {
                        students.push(student);
                    }
                });
                
                if (students.length === 0) {
                    studentsTable.innerHTML = `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                لا توجد نتائج تطابق البحث
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // بناء HTML للجدول
                let html = '';
                students.forEach(student => {
                    html += `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="py-2 px-3">${student.studentId}</td>
                            <td class="py-2 px-3">${student.name}</td>
                            <td class="py-2 px-3">${student.grade} - ${student.classRoom}</td>
                            <td class="py-2 px-3 dir-ltr text-left">
                                <a href="https://wa.me/${student.parentPhone}" target="_blank" class="text-green-600 hover:text-green-800 dark:text-green-400 dark:hover:text-green-300">
                                    ${student.parentPhone} <i class="fab fa-whatsapp ml-1"></i>
                                </a>
                            </td>
                            <td class="py-2 px-3">
                                <div class="flex space-x-1 space-x-reverse">
                                    <button class="text-primary hover:text-secondary" onclick="editStudent('${student.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="text-red-600 hover:text-red-800" onclick="showDeleteConfirmation('${student.id}', 'student')">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                    <a href="https://wa.me/${student.parentPhone}" target="_blank" class="text-green-600 hover:text-green-800">
                                        <i class="fab fa-whatsapp"></i>
                                    </a>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                studentsTable.innerHTML = html;
                
                // تحديث الإحصائيات
                updateStatCounts();
            }).catch(error => {
                console.error("خطأ في تحميل بيانات الطلاب:", error);
                studentsTable.innerHTML = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                        <td colspan="5" class="py-4 px-3 text-center text-red-500">
                            حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                        </td>
                    </tr>
                `;
            });
        }
        
        // تحميل جدول الرسائل
        function loadMessagesTable() {
            // عرض حالة التحميل
            messagesTable.innerHTML = `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        </div>
                        <p class="mt-2">جاري تحميل البيانات...</p>
                    </td>
                </tr>
            `;
            
            // جلب البيانات من Firestore مرتبة حسب التاريخ (الأحدث أولاً)
            messagesCollection.orderBy('createdAt', 'desc').get().then((querySnapshot) => {
                if (querySnapshot.empty) {
                    messagesTable.innerHTML = `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                لا توجد رسائل مرسلة حالياً
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                querySnapshot.forEach((doc) => {
                    const message = doc.data();
                    
                    // تنسيق التاريخ
                    const date = message.createdAt ? message.createdAt.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    // تنسيق نوع الرسالة
                    let typeText = 'نص';
                    if (message.type === 'pdf') typeText = 'PDF';
                    else if (message.type === 'image') typeText = 'صورة';
                    else if (message.type === 'excel') typeText = 'Excel';
                    else if (message.type === 'word') typeText = 'Word';
                    
                    // تنسيق المستلمين
                    let recipientsText = 'الجميع';
                    if (message.recipients === 'all') {
                        recipientsText = 'جميع أولياء الأمور';
                    } else if (typeof message.recipients === 'string' && message.recipients.startsWith('grade:')) {
                        recipientsText = 'الصف ' + message.recipients.replace('grade:', '');
                    } else if (typeof message.recipients === 'string' && message.recipients.startsWith('class:')) {
                        const [grade, classRoom] = message.recipients.replace('class:', '').split(':');
                        recipientsText = `الصف ${grade} - ${classRoom}`;
                    } else if (Array.isArray(message.recipients)) {
                        recipientsText = `${message.recipientCount || message.recipients.length} طالب`;
                    }
                    
                    // تنسيق المحتوى
                    let contentText = message.content;
                    if (contentText && contentText.length > 50) {
                        contentText = contentText.substring(0, 50) + '...';
                    }
                    
                    // فئة الحالة
                    let statusClass = 'status-sent';
                    if (message.status === 'pending') statusClass = 'status-pending';
                    else if (message.status === 'failed') statusClass = 'status-failed';
                    
                    html += `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="py-2 px-3">${formattedDate}</td>
                            <td class="py-2 px-3">${typeText}</td>
                            <td class="py-2 px-3">${contentText || '<span class="text-gray-400">بدون محتوى</span>'}</td>
                            <td class="py-2 px-3">${recipientsText}</td>
                            <td class="py-2 px-3">
                                <span class="message-status ${statusClass}"></span>
                                ${message.status === 'sent' ? 'تم الإرسال' : message.status === 'pending' ? 'قيد الإرسال' : 'فشل الإرسال'}
                            </td>
                        </tr>
                    `;
                });
                
                messagesTable.innerHTML = html;
            }).catch(error => {
                console.error("خطأ في تحميل سجل الرسائل:", error);
                messagesTable.innerHTML = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                        <td colspan="5" class="py-4 px-3 text-center text-red-500">
                            حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                        </td>
                    </tr>
                `;
            });
        }
        
        // تحميل جدول الرسائل المجدولة
        function loadScheduledMessagesTable() {
            // عرض حالة التحميل
            scheduledMessagesTable.innerHTML = `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        </div>
                        <p class="mt-2">جاري تحميل البيانات...</p>
                    </td>
                </tr>
            `;
            
            // جلب البيانات من Firestore مرتبة حسب موعد الإرسال
            scheduledMessagesCollection.orderBy('scheduledFor').get().then((querySnapshot) => {
                if (querySnapshot.empty) {
                    scheduledMessagesTable.innerHTML = `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                لا توجد رسائل مجدولة حالياً
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                querySnapshot.forEach((doc) => {
                    const message = doc.data();
                    
                    // تنسيق تاريخ الجدولة
                    const date = message.scheduledFor ? message.scheduledFor.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    // تنسيق المستلمين
                    let recipientsText = 'الجميع';
                    if (message.recipients === 'all') {
                        recipientsText = 'جميع أولياء الأمور';
                    } else if (typeof message.recipients === 'string' && message.recipients.startsWith('grade:')) {
                        recipientsText = 'الصف ' + message.recipients.replace('grade:', '');
                    } else if (typeof message.recipients === 'string' && message.recipients.startsWith('class:')) {
                        const [grade, classRoom] = message.recipients.replace('class:', '').split(':');
                        recipientsText = `الصف ${grade} - ${classRoom}`;
                    } else if (Array.isArray(message.recipients)) {
                        recipientsText = `${message.recipientCount || message.recipients.length} طالب`;
                    }
                    
                    // تنسيق المحتوى
                    let contentText = message.content;
                    if (contentText && contentText.length > 50) {
                        contentText = contentText.substring(0, 50) + '...';
                    }
                    
                    // فئة الحالة
                    let statusClass = 'status-scheduled';
                    let statusText = 'مجدولة';
                    if (message.status === 'sent') {
                        statusClass = 'status-sent';
                        statusText = 'تم الإرسال';
                    } else if (message.status === 'failed') {
                        statusClass = 'status-failed';
                        statusText = 'فشل الإرسال';
                    }
                    
                    html += `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="py-2 px-3">${formattedDate}</td>
                            <td class="py-2 px-3">${contentText || '<span class="text-gray-400">بدون محتوى</span>'}</td>
                            <td class="py-2 px-3">${recipientsText}</td>
                            <td class="py-2 px-3">
                                <span class="message-status ${statusClass}"></span>
                                ${statusText}
                            </td>
                            <td class="py-2 px-3">
                                <div class="flex space-x-1 space-x-reverse">
                                    ${message.status === 'scheduled' ? `
                                        <button class="text-green-600 hover:text-green-800" onclick="sendScheduledNow('${doc.id}')">
                                            <i class="fas fa-paper-plane"></i>
                                        </button>
                                        <button class="text-red-600 hover:text-red-800" onclick="showDeleteConfirmation('${doc.id}', 'scheduled')">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    ` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                scheduledMessagesTable.innerHTML = html;
            }).catch(error => {
                console.error("خطأ في تحميل الرسائل المجدولة:", error);
                scheduledMessagesTable.innerHTML = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                        <td colspan="5" class="py-4 px-3 text-center text-red-500">
                            حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                        </td>
                    </tr>
                `;
            });
        }
        
        // تحميل الإحصائيات
        function loadStats(filter = {}) {
            // عرض حالة التحميل
            document.getElementById('total-students').innerHTML = `<div class="animate-spin h-5 w-5 border-b-2 border-primary mx-auto"></div>`;
            document.getElementById('total-messages').innerHTML = `<div class="animate-spin h-5 w-5 border-b-2 border-primary mx-auto"></div>`;
            document.getElementById('weekly-messages').innerHTML = `<div class="animate-spin h-5 w-5 border-b-2 border-primary mx-auto"></div>`;
            
            // تحديث أعداد الإحصائيات
            updateStatCounts();
            
            // تهيئة أو تحديث المخططات البيانية
            updateCharts(filter);
        }
        
        // تحديث أعداد الإحصائيات
        function updateStatCounts() {
            // عدد الطلاب
            studentsCollection.get().then(snapshot => {
                document.getElementById('total-students').textContent = snapshot.size;
            });
            
            // عدد الرسائل
            messagesCollection.get().then(snapshot => {
                document.getElementById('total-messages').textContent = snapshot.size;
            });
            
            // عدد رسائل الأسبوع
            const weekStart = new Date();
            weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // بداية الأسبوع (الأحد)
            weekStart.setHours(0, 0, 0, 0);
            
            messagesCollection.where('createdAt', '>=', weekStart).get().then(snapshot => {
                document.getElementById('weekly-messages').textContent = snapshot.size;
            });
        }
        
        // تحديث المخططات البيانية
        function updateCharts(filter = {}) {
            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#e2e8f0' : '#4a5568';
            const gridColor = isDarkMode ? '#4a5568' : '#e2e8f0';
            
            // تدمير المخططات البيانية الموجودة
            if (messageTypesChart) messageTypesChart.destroy();
            if (weeklyActivityChart) weeklyActivityChart.destroy();
            if (gradeDistributionChart) gradeDistributionChart.destroy();
            
            // الحصول على بيانات المخططات
            Promise.all([
                getMessageTypeStats(filter),
                getWeeklyStats(filter),
                getGradeDistributionStats(filter)
            ]).then(([messageTypesData, weeklyStats, gradeStats]) => {
                // مخطط أنواع الرسائل
                const ctx1 = document.getElementById('message-types-chart').getContext('2d');
                messageTypesChart = new Chart(ctx1, {
                    type: 'doughnut',
                    data: {
                        labels: messageTypesData.map(item => item.type),
                        datasets: [{
                            data: messageTypesData.map(item => item.count),
                            backgroundColor: [
                                '#5D5CDE',
                                '#FF6384',
                                '#36A2EB',
                                '#FFCE56',
                                '#4BC0C0'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'right',
                                labels: {
                                    color: textColor
                                }
                            }
                        }
                    }
                });
                
                // مخطط نشاط الأسبوع
                const ctx2 = document.getElementById('weekly-activity-chart').getContext('2d');
                weeklyActivityChart = new Chart(ctx2, {
                    type: 'bar',
                    data: {
                        labels: weeklyStats.map(item => item.day),
                        datasets: [{
                            label: 'عدد الرسائل',
                            data: weeklyStats.map(item => item.count),
                            backgroundColor: '#5D5CDE',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            },
                            x: {
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        }
                    }
                });
                
                // مخطط توزيع الصفوف
                const ctx3 = document.getElementById('grade-distribution-chart').getContext('2d');
                gradeDistributionChart = new Chart(ctx3, {
                    type: 'bar',
                    data: {
                        labels: gradeStats.map(item => item.grade),
                        datasets: [
                            {
                                label: 'عدد الطلاب',
                                data: gradeStats.map(item => item.studentCount),
                                backgroundColor: '#5D5CDE',
                                borderWidth: 1
                            },
                            {
                                label: 'عدد الرسائل',
                                data: gradeStats.map(item => item.messageCount),
                                backgroundColor: '#FF6384',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            },
                            x: {
                                ticks: {
                                    color: textColor
                                },
                                grid: {
                                    color: gridColor
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: textColor
                                }
                            }
                        }
                    }
                });
            }).catch(error => {
                console.error("خطأ في تحديث المخططات البيانية:", error);
            });
        }
        
        // الحصول على إحصائيات أنواع الرسائل
        function getMessageTypeStats(filter = {}) {
            return new Promise((resolve, reject) => {
                let query = messagesCollection;
                
                // تطبيق فلاتر التاريخ إذا تم توفيرها
                if (filter.dateFrom && filter.dateTo) {
                    const fromDate = new Date(filter.dateFrom);
                    fromDate.setHours(0, 0, 0, 0);
                    
                    const toDate = new Date(filter.dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    
                    query = query.where('createdAt', '>=', fromDate).where('createdAt', '<=', toDate);
                }
                
                query.get().then(snapshot => {
                    const types = {
                        'text': 'رسائل نصية',
                        'pdf': 'ملفات PDF',
                        'image': 'صور',
                        'excel': 'ملفات Excel',
                        'word': 'ملفات Word'
                    };
                    
                    const typeCounts = {};
                    Object.keys(types).forEach(type => {
                        typeCounts[type] = 0;
                    });
                    
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        if (typeCounts[message.type] !== undefined) {
                            typeCounts[message.type]++;
                        }
                    });
                    
                    const stats = Object.keys(types).map(type => {
                        return { type: types[type], count: typeCounts[type] };
                    });
                    
                    resolve(stats);
                }).catch(error => {
                    console.error("خطأ في الحصول على إحصائيات أنواع الرسائل:", error);
                    reject(error);
                });
            });
        }
        
        // الحصول على إحصائيات الأسبوع
        function getWeeklyStats(filter = {}) {
            return new Promise((resolve, reject) => {
                // أيام الأسبوع بالعربية
                const weekdays = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء', 'الخميس', 'الجمعة', 'السبت'];
                
                // تاريخ بداية الأسبوع (الأحد)
                const firstDayOfWeek = new Date();
                firstDayOfWeek.setDate(firstDayOfWeek.getDate() - firstDayOfWeek.getDay());
                firstDayOfWeek.setHours(0, 0, 0, 0);
                
                let query = messagesCollection;
                
                // تطبيق فلاتر التاريخ إذا تم توفيرها
                if (filter.dateFrom && filter.dateTo) {
                    const fromDate = new Date(filter.dateFrom);
                    fromDate.setHours(0, 0, 0, 0);
                    
                    const toDate = new Date(filter.dateTo);
                    toDate.setHours(23, 59, 59, 999);
                    
                    query = query.where('createdAt', '>=', fromDate).where('createdAt', '<=', toDate);
                } else {
                    // إذا لم يتم توفير فلتر، نستخدم الأسبوع الحالي
                    const endOfWeek = new Date(firstDayOfWeek);
                    endOfWeek.setDate(endOfWeek.getDate() + 7);
                    query = query.where('createdAt', '>=', firstDayOfWeek).where('createdAt', '<', endOfWeek);
                }
                
                query.get().then(snapshot => {
                    // تهيئة مصفوفة لكل يوم في الأسبوع
                    const stats = weekdays.map(day => {
                        return { day, count: 0 };
                    });
                    
                    // حساب عدد الرسائل لكل يوم
                    snapshot.forEach(doc => {
                        const message = doc.data();
                        if (message.createdAt) {
                            const messageDate = message.createdAt.toDate();
                            const dayOfWeek = messageDate.getDay();
                            stats[dayOfWeek].count++;
                        }
                    });
                    
                    resolve(stats);
                }).catch(error => {
                    console.error("خطأ في الحصول على إحصائيات الأسبوع:", error);
                    reject(error);
                });
            });
        }
        
        // الحصول على إحصائيات توزيع الصفوف
        function getGradeDistributionStats(filter = {}) {
            return new Promise((resolve, reject) => {
                // جميع الصفوف المتاحة
                const grades = [
                    'روضة أولى', 'روضة ثانية', 'الأول', 'الثاني', 'الثالث', 'الرابع', 'الخامس',
                    'السادس', 'السابع', 'الثامن', 'التاسع', 'العاشر', 'الحادي عشر', 'الثاني عشر'
                ];
                
                // تهيئة بيانات الإحصائيات
                const stats = grades.map(grade => {
                    return { grade, studentCount: 0, messageCount: 0 };
                });
                
                // جلب أعداد الطلاب حسب الصف
                studentsCollection.get().then(studentSnapshot => {
                    studentSnapshot.forEach(doc => {
                        const student = doc.data();
                        const gradeIndex = grades.indexOf(student.grade);
                        if (gradeIndex !== -1) {
                            stats[gradeIndex].studentCount++;
                        }
                    });
                    
                    // جلب بيانات الرسائل
                    let query = messagesCollection;
                    
                    // تطبيق فلاتر التاريخ إذا تم توفيرها
                    if (filter.dateFrom && filter.dateTo) {
                        const fromDate = new Date(filter.dateFrom);
                        fromDate.setHours(0, 0, 0, 0);
                        
                        const toDate = new Date(filter.dateTo);
                        toDate.setHours(23, 59, 59, 999);
                        
                        query = query.where('createdAt', '>=', fromDate).where('createdAt', '<=', toDate);
                    }
                    
                    query.get().then(messageSnapshot => {
                        messageSnapshot.forEach(doc => {
                            const message = doc.data();
                            
                            // حساب عدد الرسائل لكل صف
                            if (message.recipients === 'all') {
                                // تم إرسال الرسالة إلى جميع الصفوف
                                stats.forEach(stat => {
                                    if (stat.studentCount > 0) {
                                        stat.messageCount++;
                                    }
                                });
                            } else if (typeof message.recipients === 'string' && message.recipients.startsWith('grade:')) {
                                // تم إرسال الرسالة إلى صف محدد
                                const targetGrade = message.recipients.replace('grade:', '');
                                const gradeIndex = grades.indexOf(targetGrade);
                                if (gradeIndex !== -1) {
                                    stats[gradeIndex].messageCount++;
                                }
                            } else if (typeof message.recipients === 'string' && message.recipients.startsWith('class:')) {
                                // تم إرسال الرسالة إلى فصل محدد
                                const [targetGrade] = message.recipients.replace('class:', '').split(':');
                                const gradeIndex = grades.indexOf(targetGrade);
                                if (gradeIndex !== -1) {
                                    stats[gradeIndex].messageCount++;
                                }
                            }
                            // تم تجاهل الرسائل المرسلة إلى طلاب محددين لتبسيط الإحصائيات
                        });
                        
                        resolve(stats);
                    }).catch(error => {
                        console.error("خطأ في الحصول على بيانات الرسائل:", error);
                        reject(error);
                    });
                }).catch(error => {
                    console.error("خطأ في الحصول على بيانات الطلاب:", error);
                    reject(error);
                });
            });
        }
        
        // تحميل جدول التقارير
        function loadReportsTable() {
            const reportsTable = document.getElementById('reports-table');
            
            // عرض حالة التحميل
            reportsTable.innerHTML = `
                <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                    <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                        <div class="flex justify-center">
                            <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                        </div>
                        <p class="mt-2">جاري تحميل البيانات...</p>
                    </td>
                </tr>
            `;
            
            // جلب البيانات من Firestore مرتبة حسب التاريخ (الأحدث أولاً)
            reportsCollection.orderBy('createdAt', 'desc').get().then(querySnapshot => {
                if (querySnapshot.empty) {
                    reportsTable.innerHTML = `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td colspan="5" class="py-4 px-3 text-center text-gray-500 dark:text-gray-400">
                                لا توجد تقارير سابقة
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                let html = '';
                querySnapshot.forEach(doc => {
                    const report = doc.data();
                    
                    // تنسيق التاريخ
                    const date = report.createdAt ? report.createdAt.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()}`;
                    
                    // تنسيق نوع التقرير
                    let typeText = 'بيانات الطلاب';
                    if (report.type === 'messages') typeText = 'سجل الرسائل';
                    else if (report.type === 'stats') typeText = 'إحصائيات التواصل';
                    else if (report.type === 'weekly') typeText = 'تقرير أسبوعي';
                    
                    // تنسيق الفترة
                    let periodText = '-';
                    if (report.dateFrom && report.dateTo) {
                        periodText = `${report.dateFrom} - ${report.dateTo}`;
                    }
                    
                    // تنسيق الصيغة
                    let formatText = 'Excel';
                    if (report.format === 'csv') formatText = 'CSV';
                    
                    html += `
                        <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                            <td class="py-2 px-3">${formattedDate}</td>
                            <td class="py-2 px-3">${typeText}</td>
                            <td class="py-2 px-3">${periodText}</td>
                            <td class="py-2 px-3">${formatText}</td>
                            <td class="py-2 px-3">
                                <button class="text-primary hover:text-secondary" onclick="downloadReport('${doc.id}')">
                                    <i class="fas fa-download"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                });
                
                reportsTable.innerHTML = html;
            }).catch(error => {
                console.error("خطأ في تحميل بيانات التقارير:", error);
                reportsTable.innerHTML = `
                    <tr class="border-b dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-800">
                        <td colspan="5" class="py-4 px-3 text-center text-red-500">
                            حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                        </td>
                    </tr>
                `;
            });
        }
        
        // تحميل خانات اختيار الطلاب
        function loadStudentsCheckboxes() {
            // عرض حالة التحميل
            studentsSelection.innerHTML = `
                <div class="text-center text-gray-500 dark:text-gray-400 py-2">
                    <div class="flex justify-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                    </div>
                    <p class="mt-2">جاري تحميل قائمة الطلاب...</p>
                </div>
            `;
            
            // جلب بيانات الطلاب من Firestore مرتبة حسب الصف ثم الفصل ثم الاسم
            studentsCollection.orderBy('grade').orderBy('classRoom').orderBy('name').get().then((querySnapshot) => {
                if (querySnapshot.empty) {
                    studentsSelection.innerHTML = `
                        <div class="text-center text-gray-500 dark:text-gray-400 py-2">
                            لا يوجد طلاب مسجلين حالياً
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                querySnapshot.forEach((doc) => {
                    const student = doc.data();
                    html += `
                        <div class="flex items-center mb-2">
                            <input type="checkbox" id="student-${doc.id}" value="${doc.id}" data-phone="${student.parentPhone}" class="h-4 w-4 text-primary focus:ring-primary border-gray-300 rounded">
                            <label for="student-${doc.id}" class="mr-2 block text-sm">
                                ${student.name} - ${student.grade} ${student.classRoom}
                            </label>
                        </div>
                    `;
                });
                
                studentsSelection.innerHTML = html;
            }).catch(error => {
                console.error("خطأ في تحميل قائمة الطلاب:", error);
                studentsSelection.innerHTML = `
                    <div class="text-center text-red-500 py-2">
                        حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.
                    </div>
                `;
            });
        }
        
        // التحقق من الرسائل المجدولة
        function checkScheduledMessages() {
            const now = new Date();
            
            // البحث عن الرسائل المجدولة التي حان وقتها
            scheduledMessagesCollection.where('status', '==', 'scheduled').where('scheduledFor', '<=', now).get().then(querySnapshot => {
                querySnapshot.forEach(doc => {
                    const message = doc.data();
                    
                    // إرسال الرسالة
                    sendScheduledNow(doc.id);
                });
            }).catch(error => {
                console.error("خطأ في التحقق من الرسائل المجدولة:", error);
            });
        }
        
        // إضافة طالب
        function addStudent() {
            const studentId = document.getElementById('student-id').value;
            const name = document.getElementById('student-name').value;
            const grade = document.getElementById('grade').value;
            const classRoom = document.getElementById('class-room').value;
            const semester = document.getElementById('semester').value;
            const gender = document.getElementById('gender').value;
            const region = document.getElementById('region').value;
            const parentPhone = document.getElementById('parent-phone').value;
            
            // التحقق من صحة رقم الهاتف
            if (!isValidPhoneNumber(parentPhone)) {
                showFormMessage('رقم الهاتف غير صحيح. يجب أن يبدأ برمز الدولة (مثال: 971512345678)', 'error');
                return;
            }
            
            // التحقق من عدم وجود رقم أساس مكرر
            studentsCollection.where('studentId', '==', studentId).get().then(querySnapshot => {
                if (!querySnapshot.empty) {
                    showFormMessage('رقم الاسيس موجود بالفعل', 'error');
                    return;
                }
                
                // إنشاء كائن الطالب
                const student = {
                    studentId,
                    name,
                    grade,
                    classRoom,
                    semester,
                    gender,
                    region,
                    parentPhone,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // إضافة الطالب إلى قاعدة البيانات
                studentsCollection.add(student).then(() => {
                    // مسح النموذج
                    studentForm.reset();
                    
                    // عرض رسالة نجاح
                    showFormMessage('تم إضافة الطالب بنجاح', 'success');
                    
                    // إعادة تحميل جدول الطلاب
                    loadStudentsTable();
                    
                    // تحديث الإحصائيات
                    updateStatCounts();
                }).catch(error => {
                    console.error("خطأ في إضافة الطالب:", error);
                    showFormMessage('حدث خطأ أثناء إضافة الطالب. يرجى المحاولة مرة أخرى.', 'error');
                });
            }).catch(error => {
                console.error("خطأ في التحقق من رقم الاسيس:", error);
                showFormMessage('حدث خطأ أثناء التحقق من رقم الاسيس. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // تعديل طالب
        function editStudent(id) {
            // جلب بيانات الطالب من Firestore
            studentsCollection.doc(id).get().then(doc => {
                if (!doc.exists) {
                    showToast('الطالب غير موجود', 'error');
                    return;
                }
                
                const student = doc.data();
                
                // ملء النموذج
                document.getElementById('edit-student-id').value = id;
                document.getElementById('edit-student-name').value = student.name;
                document.getElementById('edit-grade').value = student.grade;
                document.getElementById('edit-class-room').value = student.classRoom;
                document.getElementById('edit-semester').value = student.semester;
                document.getElementById('edit-gender').value = student.gender;
                document.getElementById('edit-region').value = student.region || '';
                document.getElementById('edit-parent-phone').value = student.parentPhone;
                
                // إظهار النافذة
                editStudentModal.classList.remove('hidden');
            }).catch(error => {
                console.error("خطأ في جلب بيانات الطالب:", error);
                showToast('حدث خطأ أثناء جلب بيانات الطالب', 'error');
            });
        }
        
        // حفظ الطالب المعدل
        function saveEditedStudent() {
            const id = document.getElementById('edit-student-id').value;
            const name = document.getElementById('edit-student-name').value;
            const grade = document.getElementById('edit-grade').value;
            const classRoom = document.getElementById('edit-class-room').value;
            const semester = document.getElementById('edit-semester').value;
            const gender = document.getElementById('edit-gender').value;
            const region = document.getElementById('edit-region').value;
            const parentPhone = document.getElementById('edit-parent-phone').value;
            
            // التحقق من صحة رقم الهاتف
            if (!isValidPhoneNumber(parentPhone)) {
                showToast('رقم الهاتف غير صحيح. يجب أن يبدأ برمز الدولة (مثال: 971512345678)', 'error');
                return;
            }
            
            // تحديث بيانات الطالب
            const student = {
                name,
                grade,
                classRoom,
                semester,
                gender,
                region,
                parentPhone,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            studentsCollection.doc(id).update(student).then(() => {
                // إخفاء النافذة
                editStudentModal.classList.add('hidden');
                
                // عرض رسالة نجاح
                showToast('تم تحديث بيانات الطالب بنجاح', 'success');
                
                // إعادة تحميل جدول الطلاب
                loadStudentsTable();
            }).catch(error => {
                console.error("خطأ في تحديث بيانات الطالب:", error);
                showToast('حدث خطأ أثناء تحديث بيانات الطالب', 'error');
            });
        }
        
        // عرض تأكيد الحذف
        function showDeleteConfirmation(id, type) {
            const modal = document.getElementById('delete-modal');
            const modalTitle = document.getElementById('delete-modal-title');
            const modalText = document.getElementById('delete-modal-text');
            const confirmBtn = document.getElementById('confirm-delete');
            
            if (type === 'student') {
                studentsCollection.doc(id).get().then(doc => {
                    if (!doc.exists) {
                        showToast('الطالب غير موجود', 'error');
                        return;
                    }
                    
                    const student = doc.data();
                    
                    modalTitle.textContent = 'حذف طالب';
                    modalText.textContent = `هل أنت متأكد من رغبتك في حذف الطالب "${student.name}"؟ لا يمكن التراجع عن هذا الإجراء.`;
                    confirmBtn.setAttribute('data-id', id);
                    confirmBtn.setAttribute('data-type', 'student');
                    
                    modal.classList.remove('hidden');
                }).catch(error => {
                    console.error("خطأ في جلب بيانات الطالب:", error);
                    showToast('حدث خطأ أثناء جلب بيانات الطالب', 'error');
                });
            } else if (type === 'scheduled') {
                modalTitle.textContent = 'حذف رسالة مجدولة';
                modalText.textContent = `هل أنت متأكد من رغبتك في حذف هذه الرسالة المجدولة؟ لا يمكن التراجع عن هذا الإجراء.`;
                confirmBtn.setAttribute('data-id', id);
                confirmBtn.setAttribute('data-type', 'scheduled');
                
                modal.classList.remove('hidden');
            }
        }
        
        // حذف طالب
        function deleteStudent(id) {
            // حذف الطالب من Firestore
            studentsCollection.doc(id).delete().then(() => {
                // عرض رسالة نجاح
                showToast('تم حذف الطالب بنجاح', 'success');
                
                // إعادة تحميل جدول الطلاب
                loadStudentsTable();
                
                // تحديث الإحصائيات
                updateStatCounts();
            }).catch(error => {
                console.error("خطأ في حذف الطالب:", error);
                showToast('حدث خطأ أثناء حذف الطالب', 'error');
            });
        }
        
        // حذف رسالة مجدولة
        function deleteScheduledMessage(id) {
            // حذف الرسالة المجدولة من Firestore
            scheduledMessagesCollection.doc(id).delete().then(() => {
                // عرض رسالة نجاح
                showToast('تم حذف الرسالة المجدولة بنجاح', 'success');
                
                // إعادة تحميل جدول الرسائل المجدولة
                loadScheduledMessagesTable();
            }).catch(error => {
                console.error("خطأ في حذف الرسالة المجدولة:", error);
                showToast('حدث خطأ أثناء حذف الرسالة المجدولة', 'error');
            });
        }
        
        // إرسال رسالة مجدولة الآن
        function sendScheduledNow(id) {
            // جلب بيانات الرسالة المجدولة
            scheduledMessagesCollection.doc(id).get().then(doc => {
                if (!doc.exists) {
                    showToast('الرسالة المجدولة غير موجودة', 'error');
                    return;
                }
                
                const message = doc.data();
                
                // عرض حالة الإرسال
                showToast('جاري إرسال الرسالة المجدولة...', 'success');
                
                // إرسال الرسالة
                sendMessage(
                    message.type, 
                    message.content, 
                    message.fileUrl, 
                    message.recipients, 
                    id,
                    message.sendMethod || 'direct',
                    message.useDelay || false,
                    message.delaySeconds || 3
                );
            }).catch(error => {
                console.error("خطأ في جلب بيانات الرسالة المجدولة:", error);
                showToast('حدث خطأ أثناء جلب بيانات الرسالة المجدولة', 'error');
            });
        }
        
        // إرسال رسالة اختبار
        function sendTestMessage() {
            // الحصول على رقم هاتف الاختبار
            const testPhoneNumber = testPhone.value.trim() || appSettings.senderPhone || '';
            
            if (!testPhoneNumber || !isValidPhoneNumber(testPhoneNumber)) {
                showToast('رقم هاتف الاختبار غير صالح. يرجى التحقق من الرقم أو إدخال رقم في الإعدادات.', 'error');
                return;
            }
            
            // إضافة توقيع إذا كان متاحاً
            let testContent = tempMessageData.content;
            if (appSettings.messageSignature && appSettings.messageSignature.trim() !== '') {
                testContent += '\n\n' + appSettings.messageSignature;
            }
            
            // إرسال رسالة اختبار
            let messageText = testContent;
            if (tempMessageData.fileUrl) {
                messageText = `${tempMessageData.fileUrl}\n\n${testContent}`;
            }
            
            // إنشاء الرابط
            const whatsappLink = `https://wa.me/${testPhoneNumber}?text=${encodeURIComponent('رسالة اختبار:\n' + messageText)}`;
            window.open(whatsappLink, '_blank');
            
            // عرض رسالة النجاح
            showMessageStatus('تم فتح نافذة واتساب لإرسال رسالة اختبار. بعد التأكد من نجاح الاختبار، يمكنك إرسال الرسالة إلى جميع المستلمين.', 'success');
        }
        
        // إرسال رسالة واتساب من النموذج
        function sendWhatsAppMessage() {
            // إرسال الرسالة
            sendMessage(
                tempMessageData.type,
                tempMessageData.content,
                tempMessageData.fileUrl,
                tempMessageData.recipients,
                null,
                tempMessageData.sendMethod,
                tempMessageData.useDelay,
                tempMessageData.delaySeconds
            );
        }
        
        // جدولة رسالة واتساب
        function scheduleWhatsAppMessage() {
            // الحصول على وقت الجدولة
            const scheduledDate = tempMessageData.scheduledDate;
            const scheduledTime = tempMessageData.scheduledTime;
            
            if (!scheduledDate || !scheduledTime) {
                showMessageStatus('يرجى تحديد التاريخ والوقت للجدولة', 'error');
                return;
            }
            
            const scheduledFor = new Date(`${scheduledDate}T${scheduledTime}`);
            
            if (scheduledFor <= new Date()) {
                showMessageStatus('يجب أن يكون موعد الجدولة في المستقبل', 'error');
                return;
            }
            
            // الحصول على أرقام هواتف المستلمين
            getPhoneNumbersFromRecipients(tempMessageData.recipients).then(phoneNumbers => {
                // إضافة التوقيع إذا كان مُهيئاً
                let finalContent = tempMessageData.content;
                if (appSettings.messageSignature && appSettings.messageSignature.trim() !== '') {
                    finalContent += '\n\n' + appSettings.messageSignature;
                }
                
                // إنشاء كائن الرسالة المجدولة
                const scheduledMessage = {
                    type: tempMessageData.type,
                    content: finalContent,
                    fileUrl: tempMessageData.fileUrl,
                    recipients: tempMessageData.recipients,
                    recipientCount: phoneNumbers.length,
                    scheduledFor,
                    status: 'scheduled',
                    sendMethod: tempMessageData.sendMethod,
                    useDelay: tempMessageData.useDelay,
                    delaySeconds: tempMessageData.delaySeconds,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                // إضافة الرسالة المجدولة إلى قاعدة البيانات
                scheduledMessagesCollection.add(scheduledMessage).then(() => {
                    // مسح النموذج
                    resetMessageForm();
                    
                    // عرض رسالة نجاح
                    showMessageStatus(`تم جدولة الرسالة بنجاح للإرسال في ${scheduledDate} الساعة ${scheduledTime}`, 'success');
                    
                    // تحديث جدول الرسائل المجدولة إذا كان مرئياً
                    if (!document.getElementById('scheduled-tab').classList.contains('hidden')) {
                        loadScheduledMessagesTable();
                    }
                }).catch(error => {
                    console.error("خطأ في إضافة الرسالة المجدولة:", error);
                    showMessageStatus('حدث خطأ أثناء جدولة الرسالة. يرجى المحاولة مرة أخرى.', 'error');
                });
            }).catch(error => {
                console.error("خطأ في الحصول على أرقام هواتف المستلمين:", error);
                showMessageStatus('حدث خطأ أثناء تجهيز الرسالة. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // إرسال رسالة
        function sendMessage(type, content, fileUrl, recipients, scheduledId = null, sendMethod = 'direct', useDelay = false, delaySeconds = 3) {
            // إضافة التوقيع إذا كان مُهيئاً
            let finalContent = content;
            if (appSettings.messageSignature && appSettings.messageSignature.trim() !== '') {
                finalContent += '\n\n' + appSettings.messageSignature;
            }
            
            // الحصول على أرقام هواتف أولياء الأمور
            getPhoneNumbersFromRecipients(recipients).then(phoneNumbers => {
                if (phoneNumbers.length === 0) {
                    showMessageStatus('لا يوجد أرقام هواتف متاحة للإرسال', 'error');
                    return;
                }
                
                // تحديث حالة الرسالة المجدولة إذا تم توفيرها
                if (scheduledId) {
                    scheduledMessagesCollection.doc(scheduledId).update({
                        status: 'sent',
                        sentAt: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error("خطأ في تحديث حالة الرسالة المجدولة:", error);
                    });
                    
                    // تحديث جدول الرسائل المجدولة
                    loadScheduledMessagesTable();
                }
                
                // التحقق مما إذا كان الإرسال على دفعات مُمكن أو تم طلبه صراحةً
                const useBatchSending = (appSettings.batchSending && phoneNumbers.length > 1) || (useDelay && phoneNumbers.length > 1);
                const batchSize = appSettings.batchSize || 5;
                
                // عرض حالة التحميل
                messageStatus.innerHTML = `
                    <div class="flex items-center justify-center">
                        <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-primary"></div>
                        <span class="mr-2">جاري تجهيز الرسالة...</span>
                    </div>
                `;
                messageStatus.classList.remove('hidden');
                
                if (useBatchSending) {
                    // إعداد عرض التقدم
                    sendProgressTotal.textContent = phoneNumbers.length;
                    sendProgressCurrent.textContent = '0';
                    sendProgressPercent.textContent = '0%';
                    sendProgressBar.style.width = '0%';
                    sendProgressInfo.textContent = 'جاري بدء الإرسال...';
                    sendProgress.classList.remove('hidden');
                    
                    // الإرسال على دفعات
                    sendMessageBatch(type, finalContent, fileUrl, phoneNumbers, 0, batchSize, sendMethod, recipients, scheduledId, useDelay, delaySeconds);
                } else {
                    // إرسال الرسالة لجميع المستلمين
                    handleMessageSending(type, finalContent, fileUrl, phoneNumbers, sendMethod);
                    
                    // إضافة الرسالة إلى قاعدة البيانات
                    addMessageToDatabase(type, finalContent, fileUrl, recipients, phoneNumbers.length);
                    
                    // مسح النموذج إذا لم تكن من رسالة مجدولة
                    if (!scheduledId) {
                        resetMessageForm();
                    }
                    
                    // تحديث جدول الرسائل
                    loadMessagesTable();
                    
                    // تحديث الإحصائيات
                    updateStatCounts();
                }
            }).catch(error => {
                console.error("خطأ في الحصول على أرقام هواتف المستلمين:", error);
                showMessageStatus('حدث خطأ أثناء تجهيز الرسالة. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // معالجة إرسال الرسالة
        function handleMessageSending(type, content, fileUrl, phoneNumbers, sendMethod) {
            // تحضير نص الرسالة
            let messageText = content;
            
            // إضافة الملف إذا وجد
            if (fileUrl) {
                messageText = `${fileUrl}\n\n${content}`;
            }
            
            if (sendMethod === 'direct') {
                // الإرسال المباشر عبر wa.me
                for (let i = 0; i < phoneNumbers.length; i++) {
                    const whatsappLink = `https://wa.me/${phoneNumbers[i]}?text=${encodeURIComponent(messageText)}`;
                    window.open(whatsappLink, '_blank');
                }
                
                // عرض رسالة نجاح
                showMessageStatus(`تم فتح نوافذ واتساب لإرسال الرسالة إلى ${phoneNumbers.length} مستلم`, 'success');
            } else {
                // الإرسال عبر واتساب ويب
                const senderPhone = appSettings.senderPhone || '';
                
                if (senderPhone) {
                    // إرسال مع قائمة المستلمين
                    const recipientsList = phoneNumbers.join(', ');
                    const finalMessage = `${messageText}\n\nالمستلمون: ${recipientsList}`;
                    
                    const whatsappLink = `https://web.whatsapp.com/send?phone=${senderPhone}&text=${encodeURIComponent(finalMessage)}`;
                    window.open(whatsappLink, '_blank');
                    
                    // عرض رسالة نجاح
                    showMessageStatus(`تم فتح واتساب ويب لإرسال الرسالة إلى ${phoneNumbers.length} مستلم`, 'success');
                } else {
                    // إذا لم يتم تعيين رقم المرسل، نستخدم الطريقة المباشرة
                    handleMessageSending(type, content, fileUrl, phoneNumbers, 'direct');
                }
            }
        }
        
        // إرسال رسالة على دفعات
        function sendMessageBatch(type, content, fileUrl, phoneNumbers, startIndex, batchSize, sendMethod, recipients, scheduledId = null, useDelay = false, delaySeconds = 3) {
            const endIndex = Math.min(startIndex + batchSize, phoneNumbers.length);
            const currentBatch = phoneNumbers.slice(startIndex, endIndex);
            
            // تحديث التقدم
            const progress = Math.round((startIndex / phoneNumbers.length) * 100);
            sendProgressCurrent.textContent = startIndex;
            sendProgressPercent.textContent = progress + '%';
            sendProgressBar.style.width = progress + '%';
            sendProgressInfo.textContent = `جاري إرسال الدفعة ${Math.floor(startIndex / batchSize) + 1} من ${Math.ceil(phoneNumbers.length / batchSize)}...`;
            
            // إرسال إلى الدفعة الحالية
            handleMessageSending(type, content, fileUrl, currentBatch, sendMethod);
            
            // التحقق مما إذا كنا انتهينا
            if (endIndex >= phoneNumbers.length) {
                // تحديث التقدم إلى 100%
                sendProgressCurrent.textContent = phoneNumbers.length;
                sendProgressPercent.textContent = '100%';
                sendProgressBar.style.width = '100%';
                sendProgressInfo.textContent = 'تم الإرسال بنجاح!';
                
                // إضافة الرسالة إلى قاعدة البيانات
                addMessageToDatabase(type, content, fileUrl, recipients, phoneNumbers.length);
                
                // مسح النموذج إذا لم تكن من رسالة مجدولة
                if (!scheduledId) {
                    resetMessageForm();
                }
                
                // عرض رسالة نجاح
                showMessageStatus(`تم إرسال الرسالة بنجاح إلى ${phoneNumbers.length} مستلم`, 'success');
                
                // إخفاء التقدم بعد تأخير
                setTimeout(() => {
                    sendProgress.classList.add('hidden');
                }, 3000);
                
                // تحديث جدول الرسائل
                loadMessagesTable();
                
                // تحديث الإحصائيات
                updateStatCounts();
            } else {
                // حساب التأخير بين الدفعات
                const delay = useDelay ? delaySeconds * 1000 : 2000;
                
                // تحديث معلومات الانتظار
                sendProgressInfo.textContent = `الانتظار ${useDelay ? delaySeconds : 2} ثانية قبل الدفعة التالية...`;
                
                // معالجة الدفعة التالية بعد تأخير
                setTimeout(() => {
                    sendMessageBatch(type, content, fileUrl, phoneNumbers, endIndex, batchSize, sendMethod, recipients, scheduledId, useDelay, delaySeconds);
                }, delay);
            }
        }
        
        // إضافة رسالة إلى قاعدة البيانات
        function addMessageToDatabase(type, content, fileUrl, recipients, recipientCount) {
            const message = {
                type,
                content,
                fileUrl,
                recipients,
                recipientCount,
                status: 'sent',
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            messagesCollection.add(message).catch(error => {
                console.error("خطأ في إضافة الرسالة إلى قاعدة البيانات:", error);
            });
        }
        
        // إعادة تعيين نموذج الرسالة
        function resetMessageForm() {
            messageForm.reset();
            textMessageContainer.classList.remove('hidden');
            fileMessageContainer.classList.add('hidden');
            gradeFilter.classList.add('hidden');
            classFilter.classList.add('hidden');
            individualFilter.classList.add('hidden');
            scheduleContainer.classList.add('hidden');
            filePreviewContainer.classList.add('hidden');
            fileUploadInfo.classList.add('hidden');
            delayOptions.classList.add('hidden');
            
            // مسح ملف التحميل الحالي
            currentFileUpload = null;
        }
        
        // إنشاء تقرير
        function generateReport() {
            const type = document.getElementById('report-type').value;
            const dateFrom = document.getElementById('report-date-from').value;
            const dateTo = document.getElementById('report-date-to').value;
            const grade = document.getElementById('report-grade').value;
            const format = document.getElementById('report-format').value;
            
            if (type !== 'students' && (!dateFrom || !dateTo)) {
                showToast('يرجى تحديد نطاق التاريخ للتقرير', 'error');
                return;
            }
            
            // إنشاء كائن التقرير
            const report = {
                type,
                dateFrom,
                dateTo,
                grade,
                format,
                fileName: getReportFileName(type, dateFrom, dateTo, grade),
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // إضافة التقرير إلى قاعدة البيانات
            reportsCollection.add(report).then(docRef => {
                // تصدير البيانات حسب نوع التقرير
                switch (type) {
                    case 'students':
                        exportStudentsToExcel(format, grade, report.fileName);
                        break;
                    case 'messages':
                        exportMessagesToExcel(format, dateFrom, dateTo, grade, report.fileName);
                        break;
                    case 'stats':
                        exportStatsToExcel(format, dateFrom, dateTo, report.fileName);
                        break;
                    case 'weekly':
                        exportWeeklyReportToExcel(format, report.fileName);
                        break;
                }
                
                // عرض رسالة نجاح
                showToast('تم إنشاء التقرير بنجاح', 'success');
                
                // تحديث جدول التقارير
                loadReportsTable();
            }).catch(error => {
                console.error("خطأ في إضافة التقرير:", error);
                showToast('حدث خطأ أثناء إنشاء التقرير. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // الحصول على اسم ملف التقرير
        function getReportFileName(type, dateFrom, dateTo, grade) {
            let fileName = '';
            
            switch (type) {
                case 'students':
                    fileName = 'بيانات_الطلاب';
                    if (grade) {
                        fileName += '_' + grade;
                    }
                    break;
                case 'messages':
                    fileName = 'سجل_الرسائل';
                    if (dateFrom && dateTo) {
                        fileName += `_${dateFrom}_${dateTo}`;
                    }
                    if (grade) {
                        fileName += '_' + grade;
                    }
                    break;
                case 'stats':
                    fileName = 'إحصائيات_التواصل';
                    if (dateFrom && dateTo) {
                        fileName += `_${dateFrom}_${dateTo}`;
                    }
                    break;
                case 'weekly':
                    fileName = 'تقرير_أسبوعي';
                    const today = new Date();
                    fileName += `_${today.getFullYear()}-${today.getMonth() + 1}-${today.getDate()}`;
                    break;
            }
            
            return fileName;
        }
        
        // تنزيل تقرير
        function downloadReport(id) {
            // جلب بيانات التقرير
            reportsCollection.doc(id).get().then(doc => {
                if (!doc.exists) {
                    showToast('التقرير غير موجود', 'error');
                    return;
                }
                
                const report = doc.data();
                
                // تصدير البيانات حسب نوع التقرير
                switch (report.type) {
                    case 'students':
                        exportStudentsToExcel(report.format, report.grade, report.fileName);
                        break;
                    case 'messages':
                        exportMessagesToExcel(report.format, report.dateFrom, report.dateTo, report.grade, report.fileName);
                        break;
                    case 'stats':
                        exportStatsToExcel(report.format, report.dateFrom, report.dateTo, report.fileName);
                        break;
                    case 'weekly':
                        exportWeeklyReportToExcel(report.format, report.fileName);
                        break;
                }
                
                showToast('تم تحميل التقرير بنجاح', 'success');
            }).catch(error => {
                console.error("خطأ في جلب بيانات التقرير:", error);
                showToast('حدث خطأ أثناء تحميل التقرير. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // تصدير بيانات الطلاب إلى Excel
        function exportStudentsToExcel(format = 'excel', grade = '', fileName = 'بيانات_الطلاب') {
            let query = studentsCollection;
            
            // تطبيق فلتر الصف إذا تم توفيره
            if (grade) {
                query = query.where('grade', '==', grade);
            }
            
            query.get().then(querySnapshot => {
                if (querySnapshot.empty) {
                    showToast('لا توجد بيانات للتصدير', 'error');
                    return;
                }
                
                // تحويل البيانات إلى تنسيق مناسب للتصدير
                const data = [];
                querySnapshot.forEach(doc => {
                    const student = doc.data();
                    data.push({
                        'رقم الاسيس': student.studentId,
                        'الاسم': student.name,
                        'الصف': student.grade,
                        'الفصل': student.classRoom,
                        'الفصل الدراسي': student.semester,
                        'الجنس': student.gender,
                        'المنطقة': student.region || '',
                        'رقم هاتف ولي الأمر': student.parentPhone
                    });
                });
                
                // تصدير البيانات
                exportToExcel(data, fileName, format);
            }).catch(error => {
                console.error("خطأ في جلب بيانات الطلاب للتصدير:", error);
                showToast('حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // تصدير سجل الرسائل إلى Excel
        function exportMessagesToExcel(format = 'excel', dateFrom = '', dateTo = '', grade = '', fileName = 'سجل_الرسائل') {
            let query = messagesCollection;
            
            // تطبيق فلاتر التاريخ إذا تم توفيرها
            if (dateFrom && dateTo) {
                const fromDate = new Date(dateFrom);
                fromDate.setHours(0, 0, 0, 0);
                
                const toDate = new Date(dateTo);
                toDate.setHours(23, 59, 59, 999);
                
                query = query.where('createdAt', '>=', fromDate).where('createdAt', '<=', toDate);
            }
            
            query.orderBy('createdAt', 'desc').get().then(querySnapshot => {
                if (querySnapshot.empty) {
                    showToast('لا توجد بيانات للتصدير', 'error');
                    return;
                }
                
                // تحويل البيانات إلى تنسيق مناسب للتصدير
                const data = [];
                querySnapshot.forEach(doc => {
                    const message = doc.data();
                    
                    // تجاهل الرسائل التي لا تناسب فلتر الصف
                    if (grade && typeof message.recipients === 'string') {
                        if (message.recipients === 'all') {
                            // تضمين الرسائل المرسلة إلى جميع الطلاب
                        } else if (message.recipients.startsWith('grade:')) {
                            const messageGrade = message.recipients.replace('grade:', '');
                            if (messageGrade !== grade) {
                                return; // تخطي هذه الرسالة
                            }
                        } else if (message.recipients.startsWith('class:')) {
                            const [messageGrade] = message.recipients.replace('class:', '').split(':');
                            if (messageGrade !== grade) {
                                return; // تخطي هذه الرسالة
                            }
                        }
                    }
                    
                    // تنسيق التاريخ
                    const date = message.createdAt ? message.createdAt.toDate() : new Date();
                    const formattedDate = `${date.getDate()}/${date.getMonth() + 1}/${date.getFullYear()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                    
                    // تنسيق نوع الرسالة
                    let typeText = 'نص';
                    if (message.type === 'pdf') typeText = 'PDF';
                    else if (message.type === 'image') typeText = 'صورة';
                    else if (message.type === 'excel') typeText = 'Excel';
                    else if (message.type === 'word') typeText = 'Word';
                    
                    // تنسيق المستلمين
                    let recipientsText = 'الجميع';
                    if (message.recipients === 'all') {
                        recipientsText = 'جميع أولياء الأمور';
                    } else if (typeof message.recipients === 'string' && message.recipients.startsWith('grade:')) {
                        recipientsText = 'الصف ' + message.recipients.replace('grade:', '');
                    } else if (typeof message.recipients === 'string' && message.recipients.startsWith('class:')) {
                        const [messageGrade, classRoom] = message.recipients.replace('class:', '').split(':');
                        recipientsText = `الصف ${messageGrade} - ${classRoom}`;
                    } else if (Array.isArray(message.recipients)) {
                        recipientsText = `${message.recipientCount || message.recipients.length} طالب`;
                    }
                    
                    data.push({
                        'التاريخ': formattedDate,
                        'النوع': typeText,
                        'المحتوى': message.content || '',
                        'المستلمون': recipientsText,
                        'الحالة': message.status === 'sent' ? 'تم الإرسال' : message.status === 'pending' ? 'قيد الإرسال' : 'فشل الإرسال'
                    });
                });
                
                // تصدير البيانات
                exportToExcel(data, fileName, format);
            }).catch(error => {
                console.error("خطأ في جلب بيانات الرسائل للتصدير:", error);
                showToast('حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // تصدير الإحصائيات إلى Excel
        function exportStatsToExcel(format = 'excel', dateFrom = '', dateTo = '', fileName = 'إحصائيات_التواصل') {
            // الحصول على الإحصائيات
            Promise.all([
                getMessageTypeStats({ dateFrom, dateTo }),
                getWeeklyStats({ dateFrom, dateTo }),
                getGradeDistributionStats({ dateFrom, dateTo })
            ]).then(([messageTypesData, weeklyStats, gradeStats]) => {
                // تنسيق البيانات للتصدير
                const data = [];
                
                // إضافة قسم إحصائيات أنواع الرسائل
                data.push({ 'القسم': 'إحصائيات أنواع الرسائل' });
                messageTypesData.forEach(stat => {
                    data.push({
                        'النوع': stat.type,
                        'العدد': stat.count
                    });
                });
                
                // إضافة قسم إحصائيات حسب الصف
                data.push({ 'القسم': 'إحصائيات حسب الصف' });
                gradeStats.forEach(stat => {
                    data.push({
                        'الصف': stat.grade,
                        'عدد الطلاب': stat.studentCount,
                        'عدد الرسائل': stat.messageCount
                    });
                });
                
                // إضافة قسم إحصائيات الأسبوع
                data.push({ 'القسم': 'إحصائيات الأسبوع' });
                weeklyStats.forEach(stat => {
                    data.push({
                        'اليوم': stat.day,
                        'عدد الرسائل': stat.count
                    });
                });
                
                // تصدير البيانات
                exportToExcel(data, fileName, format);
            }).catch(error => {
                console.error("خطأ في جلب الإحصائيات للتصدير:", error);
                showToast('حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // تصدير التقرير الأسبوعي إلى Excel
        function exportWeeklyReportToExcel(format = 'excel', fileName = 'تقرير_أسبوعي') {
            // الحصول على إحصائيات الأسبوع
            getWeeklyStats().then(weeklyStats => {
                // تنسيق البيانات للتصدير
                const data = weeklyStats.map(stat => ({
                    'اليوم': stat.day,
                    'عدد الرسائل': stat.count
                }));
                
                // تصدير البيانات
                exportToExcel(data, fileName, format);
            }).catch(error => {
                console.error("خطأ في جلب إحصائيات الأسبوع للتصدير:", error);
                showToast('حدث خطأ أثناء تحميل البيانات. يرجى المحاولة مرة أخرى.', 'error');
            });
        }
        
        // تصدير إلى Excel
        function exportToExcel(data, fileName, format = 'excel') {
            if (!data || data.length === 0) return;
            
            // إنشاء مصنف عمل
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data, { header: Object.keys(data[0]) });
            
            // إضافة ورقة عمل إلى المصنف
            XLSX.utils.book_append_sheet(wb, ws, "Sheet1");
            
            // إنشاء جدول بيانات
            const wbout = format === 'excel' ? 
                XLSX.write(wb, { bookType: 'xlsx', type: 'array' }) : 
                XLSX.write(wb, { bookType: 'csv', type: 'array' });
            
            // إنشاء كائن Blob
            const blob = new Blob([wbout], { type: format === 'excel' ? 'application/octet-stream' : 'text/csv' });
            
            // إنشاء URL للتنزيل
            const url = window.URL.createObjectURL(blob);
            
            // إنشاء رابط التنزيل
            const a = document.createElement('a');
            a.href = url;
            a.download = `${fileName}.${format === 'excel' ? 'xlsx' : 'csv'}`;
            document.body.appendChild(a);
            a.click();
            
            // تنظيف
            setTimeout(() => {
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }, 0);
        }
        
        // عرض رسالة في النموذج
        function showFormMessage(message, type = 'success') {
            formMessage.textContent = message;
            formMessage.className = type === 'success' ? 'mt-3 text-center text-green-600 dark:text-green-400' : 'mt-3 text-center text-red-600 dark:text-red-400';
            formMessage.classList.remove('hidden');
            
            setTimeout(() => {
                formMessage.classList.add('hidden');
            }, 5000);
        }
        
        // عرض حالة الرسالة
        function showMessageStatus(message, type = 'success') {
            messageStatus.textContent = message;
            messageStatus.className = type === 'success' ? 'mt-3 text-center text-green-600 dark:text-green-400' : 'mt-3 text-center text-red-600 dark:text-red-400';
            messageStatus.classList.remove('hidden');
            
            setTimeout(() => {
                messageStatus.classList.add('hidden');
            }, 5000);
        }
        
        // عرض إشعار توست
        function showToast(message, type = 'success') {
            toastMessage.textContent = message;
            
            if (type === 'success') {
                toast.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg bg-green-600 text-white transition-all transform translate-y-0 opacity-100 duration-300 z-50 flex items-center';
            } else {
                toast.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg bg-red-600 text-white transition-all transform translate-y-0 opacity-100 duration-300 z-50 flex items-center';
            }
            
            setTimeout(() => {
                toast.className = 'fixed bottom-4 right-4 px-4 py-2 rounded-lg text-white transition-all transform translate-y-12 opacity-0 duration-300 z-50 flex items-center';
            }, 3000);
        }
        
        // الحصول على أرقام هواتف المستلمين
        function getPhoneNumbersFromRecipients(recipients) {
            return new Promise((resolve, reject) => {
                const phoneNumbers = [];
                
                if (recipients === 'all') {
                    // الحصول على جميع أرقام هواتف أولياء الأمور
                    studentsCollection.get().then(querySnapshot => {
                        if (querySnapshot.empty) {
                            console.warn("لا يوجد طلاب مسجلين");
                            resolve([]);
                            return;
                        }
                        
                        querySnapshot.forEach(doc => {
                            const student = doc.data();
                            if (student.parentPhone && isValidPhoneNumber(student.parentPhone) && !phoneNumbers.includes(student.parentPhone)) {
                                phoneNumbers.push(student.parentPhone);
                            }
                        });
                        console.log(`تم العثور على ${phoneNumbers.length} رقم هاتف للإرسال الجماعي`);
                        resolve(phoneNumbers);
                    }).catch(error => {
                        console.error("خطأ في جلب أرقام هواتف جميع المستلمين:", error);
                        reject(error);
                    });
                } else if (typeof recipients === 'string' && recipients.startsWith('grade:')) {
                    const grade = recipients.replace('grade:', '');
                    console.log(`جلب الطلاب من الصف: ${grade}`);
                    
                    // الحصول على طلاب هذا الصف
                    studentsCollection.where('grade', '==', grade).get().then(querySnapshot => {
                        if (querySnapshot.empty) {
                            console.warn(`لا يوجد طلاب في الصف ${grade}`);
                            resolve([]);
                            return;
                        }
                        
                        querySnapshot.forEach(doc => {
                            const student = doc.data();
                            if (student.parentPhone && isValidPhoneNumber(student.parentPhone) && !phoneNumbers.includes(student.parentPhone)) {
                                phoneNumbers.push(student.parentPhone);
                            }
                        });
                        console.log(`تم العثور على ${phoneNumbers.length} رقم هاتف للطلاب في الصف ${grade}`);
                        resolve(phoneNumbers);
                    }).catch(error => {
                        console.error(`خطأ في جلب أرقام هواتف طلاب الصف ${grade}:`, error);
                        reject(error);
                    });
                } else if (typeof recipients === 'string' && recipients.startsWith('class:')) {
                    const [grade, classRoom] = recipients.replace('class:', '').split(':');
                    console.log(`جلب الطلاب من الصف ${grade} فصل ${classRoom}`);
                    
                    // الحصول على طلاب هذا الفصل
                    studentsCollection.where('grade', '==', grade).where('classRoom', '==', classRoom).get().then(querySnapshot => {
                        if (querySnapshot.empty) {
                            console.warn(`لا يوجد طلاب في الصف ${grade} فصل ${classRoom}`);
                            resolve([]);
                            return;
                        }
                        
                        querySnapshot.forEach(doc => {
                            const student = doc.data();
                            if (student.parentPhone && isValidPhoneNumber(student.parentPhone) && !phoneNumbers.includes(student.parentPhone)) {
                                phoneNumbers.push(student.parentPhone);
                            }
                        });
                        console.log(`تم العثور على ${phoneNumbers.length} رقم هاتف للطلاب في الصف ${grade} فصل ${classRoom}`);
                        resolve(phoneNumbers);
                    }).catch(error => {
                        console.error(`خطأ في جلب أرقام هواتف طلاب الصف ${grade} فصل ${classRoom}:`, error);
                        reject(error);
                    });
                } else if (Array.isArray(recipients) && recipients.length > 0) {
                    // الحصول على طلاب محددين - تحسين الطريقة باستخدام الباتش
                    console.log(`جلب معلومات ${recipients.length} طالب محدد`);
                    
                    // دالة مساعدة لتقسيم المصفوفة إلى مجموعات
                    const chunkArray = (array, size) => {
                        const chunks = [];
                        for (let i = 0; i < array.length; i += size) {
                            chunks.push(array.slice(i, i + size));
                        }
                        return chunks;
                    };
                    
                    // تقسيم الطلاب إلى مجموعات لتجنب الحد الأقصى للاستعلامات
                    const batches = chunkArray(recipients, 10);
                    const batchPromises = [];
                    
                    batches.forEach(batch => {
                        const batchPromise = Promise.all(
                            batch.map(studentId => studentsCollection.doc(studentId).get())
                        ).then(docs => {
                            docs.forEach(doc => {
                                if (doc.exists) {
                                    const student = doc.data();
                                    if (student.parentPhone && isValidPhoneNumber(student.parentPhone) && !phoneNumbers.includes(student.parentPhone)) {
                                        phoneNumbers.push(student.parentPhone);
                                    }
                                }
                            });
                        });
                        batchPromises.push(batchPromise);
                    });
                    
                    Promise.all(batchPromises)
                        .then(() => {
                            console.log(`تم العثور على ${phoneNumbers.length} رقم هاتف صحيح للطلاب المحددين`);
                            resolve(phoneNumbers);
                        })
                        .catch(error => {
                            console.error("خطأ في جلب أرقام هواتف الطلاب المحددين:", error);
                            reject(error);
                        });
                } else {
                    console.warn("تم تمرير نوع مستلمين غير معروف:", recipients);
                    resolve([]);
                }
            });
        }
        
        // التحقق من صحة رقم الهاتف
        function isValidPhoneNumber(phone) {
            // تحقق بسيط، يجب أن يبدأ برمز دولي
            return /^\d{10,15}$/.test(phone);
        }
        
        // تهيئة التطبيق عند تحميل DOM
        document.addEventListener('DOMContentLoaded', initApp);
        
        // جعل الدوال متاحة عالمياً
        window.editStudent = editStudent;
        window.showDeleteConfirmation = showDeleteConfirmation;
        window.deleteStudent = deleteStudent;
        window.downloadReport = downloadReport;
        window.deleteScheduledMessage = deleteScheduledMessage;
        window.sendScheduledNow = sendScheduledNow;
    </script>
</body>
</html>

